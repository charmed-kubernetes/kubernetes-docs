<p><strong>Charmed Kubernetes</strong> includes the standard
<strong>Kubernetes</strong> dashboard for monitoring your cluster. However, it is often advisable to
have a monitoring solution which will run whether the cluster itself is running or not. It
may also be useful to integrate monitoring into existing setups.</p>

<p><strong>Prometheus</strong> is the recommended way to monitor your deployment - instructions are
provided below. There are also instructions for setting up other monitoring
solutions, or connecting to existing monitoring setups.</p>

<h2 id="monitoring-with-prometheus-grafana-and-telegraf">Monitoring with Prometheus, Grafana, and Telegraf</h2>

<p>The recommended way to monitor your cluster is to use a combination of
<strong>Prometheus</strong>, <strong>Grafana</strong> and <strong>Telegraf</strong>. These provide a dashboard
from which you can monitor both machine-level and cluster-level metrics.
See the <a href="/kubernetes/docs/quickstart">quickstart guide</a> for more details on installing <strong>Charmed Kubernetes</strong>.</p>

<h3 id="installation">Installation</h3>

<p>You can install <strong>Charmed Kubernetes</strong> with monitoring using the Juju bundle
along with the following overlay file (<a href="https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/monitoring-pgt-overlay.yaml">download it here</a>):</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">prometheus</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:prometheus2</span>
    <span class="na">constraints</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mem=4G</span><span class="nv"> </span><span class="s">root-disk=16G"</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">grafana</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:grafana</span>
    <span class="na">expose</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">telegraf</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:telegraf</span>
<span class="na">relations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">prometheus</span><span class="pi">:</span><span class="nv">grafana-source</span><span class="pi">,</span> <span class="nv">grafana</span><span class="pi">:</span><span class="nv">grafana-source</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">telegraf</span><span class="pi">:</span><span class="nv">prometheus-client</span><span class="pi">,</span> <span class="nv">prometheus</span><span class="pi">:</span><span class="nv">target</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">kubernetes-master</span><span class="pi">:</span><span class="nv">juju-info</span><span class="pi">,</span> <span class="nv">telegraf</span><span class="pi">:</span><span class="nv">juju-info</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">kubernetes-worker</span><span class="pi">:</span><span class="nv">juju-info</span><span class="pi">,</span> <span class="nv">telegraf</span><span class="pi">:</span><span class="nv">juju-info</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">kubernetes-master</span><span class="pi">:</span><span class="nv">prometheus</span><span class="pi">,</span> <span class="nv">prometheus</span><span class="pi">:</span><span class="nv">manual-jobs</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="nv">kubernetes-master</span><span class="pi">:</span><span class="nv">grafana</span><span class="pi">,</span> <span class="nv">grafana</span><span class="pi">:</span><span class="nv">dashboards</span><span class="pi">]</span>
</code></pre></div></div>

<p>To use this overlay with the <strong>Charmed Kubernetes</strong> bundle, specify it 
during deploy like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes <span class="nt">--overlay</span> ~/path/monitoring-pgt-overlay.yaml
</code></pre></div></div>

<p>If you wish to add monitoring to an existing deployment, you can export a
bundle of your current environment and then redeploy it on top of itself with
the overlay:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju export-bundle <span class="nt">--filename</span> mybundle.yaml
juju deploy ./mybundle.yaml <span class="nt">--overlay</span> ~/path/monitoring-pgt-overlay.yaml
</code></pre></div></div>

<h3 id="retrieve-credentials-and-login">Retrieve credentials and login</h3>

<p>To open the dashboard in your browser you will need to know the URL and login
credentials for Grafana. These can be retrieved with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action <span class="nt">--wait</span> grafana/0 get-login-info
</code></pre></div></div>

<p>This will return the connection and login information, like the following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">unit-grafana-0</span><span class="pi">:</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">a74acea6-8be9-43c1-8f1c-b1bebe9f5153</span>
  <span class="na">results</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">http://10.4.23.162:3000</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">admin</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">NYZVkNb3jbMMhWhx</span>
  <span class="na">status</span><span class="pi">:</span> <span class="s">completed</span>
  <span class="na">timing</span><span class="pi">:</span>
    <span class="na">completed</span><span class="pi">:</span> <span class="s">2019-07-29 22:00:29 +0000 UTC</span>
    <span class="na">enqueued</span><span class="pi">:</span> <span class="s">2019-07-29 22:00:27 +0000 UTC</span>
    <span class="na">started</span><span class="pi">:</span> <span class="s">2019-07-29 22:00:28 +0000 UTC</span>
  <span class="na">unit</span><span class="pi">:</span> <span class="s">grafana/0</span>
</code></pre></div></div>

<p>With that, you can visit the URL and log in using the username and password.</p>

<p>Once logged in, check out the cluster metric dashboard by clicking the <code class="highlighter-rouge">Home</code>
drop-down box and selecting <code class="highlighter-rouge">Kubernetes Metrics (via Prometheus)</code>:</p>

<p><img src="https://assets.ubuntu.com/v1/e6934269-grafana-1.png" alt="grafana dashboard image" /></p>

<p>You can also check out the system metrics of the cluster by switching the
drop-down box to `Node Metrics (via Telegraf):</p>

<p><img src="https://assets.ubuntu.com/v1/45b87639-grafana-2.png" alt="grafana dashboard image" /></p>

<h3 id="using-kube-state-metrics">Using kube-state-metrics</h3>

<p>The <a href="https://github.com/kubernetes/kube-state-metrics">kube-state-metrics project</a>
is a useful addon for monitoring workloads and their statuses. This involves
installing a pod and service into Kubernetes, pointing Prometheus at that
endpoint for scraping, and then setting up Grafana to use this data.</p>

<h4 id="installing-kube-state-metrics">Installing kube-state-metrics</h4>

<p>Starting with Charmed Kubernetes 1.17,
<a href="https://github.com/kubernetes/kube-state-metrics">kube-state-metrics</a>
are added, automatically, when <code class="highlighter-rouge">enable-metrics</code> is set to  <code class="highlighter-rouge">true </code> on the
<code class="highlighter-rouge">kubernetes-master</code> charm.  This is enabled by default.  Enable
with the following command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master enable-metrics<span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<h4 id="viewing-kube-state-metrics">Viewing kube-state-metrics</h4>

<p>To view metrics scraped from
<a href="https://github.com/kubernetes/kube-state-metrics">kube-state-metrics</a>,
refer to
<a href="#monitoring-with-prometheus-grafana-and-telegraf">Monitoring with Prometheus, Grafana, and Telegraf</a>
and enable Grafana.  You can then open the <strong>Charmed Kubernetes Dashboard</strong>.</p>

<h2 id="monitoring-with-nagios">Monitoring with Nagios</h2>

<p><strong>Nagios</strong> (<a href="https://www.nagios.org/">https://www.nagios.org/</a>) is widely used for monitoring
networks, servers and applications. Using the Nagios Remote Plugin Executor
(NRPE) on each node, it can monitor your cluster with machine-level detail.</p>

<p>To start, deploy the latest version of the Nagios and NRPE Juju charms:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy nagios <span class="nt">--series</span><span class="o">=</span>bionic
juju deploy nrpe <span class="nt">--series</span><span class="o">=</span>bionic
juju expose nagios
</code></pre></div></div>

<p>Connect <strong>Nagios</strong> to NRPE:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju add-relation nagios nrpe
</code></pre></div></div>

<p>Now add relations to NRPE for all the applications you wish to monitor, for
example kubernetes-master, kubernetes-worker, etcd, easyrsa, and
kubeapi-load-balancer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju add-relation nrpe kubernetes-master
juju add-relation nrpe kubernetes-worker
juju add-relation nrpe etcd
juju add-relation nrpe easyrsa
juju add-relation nrpe kubeapi-load-balancer
</code></pre></div></div>

<p>To connect to the Nagios server, you will need its IP address:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status <span class="nt">--format</span> yaml nagios/0 | <span class="nb">grep </span>public-address
</code></pre></div></div>

<p>The default username is <code class="highlighter-rouge">nagiosadmin</code>. The password is randomly generated at
install time, and can be retrieved by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju ssh nagios/0 <span class="nb">sudo cat</span> /var/lib/juju/nagios.passwd
</code></pre></div></div>

<p>![nagios dashboard image][https://assets.ubuntu.com/v1/4b109895-cdk-nagios.png]</p>

<h3 id="using-an-existing-nagios-service">Using an existing Nagios service</h3>

<p>If you already have an existing <strong>Nagios</strong> installation, the <code class="highlighter-rouge">nrpe</code> charm can
be configured to work with it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config nrpe <span class="nv">export_nagios_definitions</span><span class="o">=</span><span class="nb">true
</span>juju config nrpe <span class="nv">nagios_master</span><span class="o">=</span>&lt;ip-address-of-nagios&gt;
</code></pre></div></div>

<p>See the <a href="https://jujucharms.com/nrpe/">External Nagios</a> section of the NRPE charm readme for more information.</p>

<!-- LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/monitoring.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
