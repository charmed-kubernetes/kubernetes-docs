<p>This page is intended to deal with specific, special circumstances you may
encounter when upgrading between versions of <strong>Charmed Kubernetes</strong>.
The notes are organised according to the upgrade path below, but also be aware that any
upgrade that spans more than one minor version may need to beware of notes in
any of the intervening steps.</p>

<p><a id="1.16"> </a></p>

<h2 id="upgrading-to-116">Upgrading to 1.16</h2>

<h3 id="docker-registry-with-containerd">Docker Registry with Containerd</h3>

<p>Prior to 1.16, some fixes were required to support using the
Docker Registry charm with Containerd.</p>

<p>This charm, if used, is now supported through standard relations. Before upgrading,
remove any reference of the registry in the <code class="highlighter-rouge">custom_registries</code>
<a href="/kubernetes/docs/container-runtime">containerd charm configuration</a>.</p>

<p>After upgrading, see the <a href="/kubernetes/docs/docker-registry">docker registry</a>
instructions for details of how to configure a registry.</p>

<h3 id="admission-control-plugins">Admission control plugins</h3>

<p>In <strong>Charmed Kubernetes 1.16</strong>, the API server parameter by which additional,
non-default admission control plugins is specified has changed. The old
parameter was <code class="highlighter-rouge">--admission-control</code>; the new parameter is <code class="highlighter-rouge">--enable-admission-plugins</code>.</p>

<p>For example, prior to 1.16, The ‘PodSecurityPolicy’ admission plugin could be
applied like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master api-extra-args<span class="o">=</span><span class="s2">"admission-control=PodSecurityPolicy"</span>
</code></pre></div></div>

<p>As of 1.16, this changes to:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master api-extra-args<span class="o">=</span><span class="s2">"enable-admission-plugins=PodSecurityPolicy"</span>
</code></pre></div></div>

<p>If using non-default admission plugins, be sure to upgrade your charm config
accordingly after upgrading to 1.16.</p>

<p><a id="1.15"> </a></p>

<h2 id="upgrading-to-115">Upgrading to 1.15</h2>

<p>This upgrade switches the container runtime to make use of containerd, rather
than Docker. You have the option of keeping Docker as the container runtime,
but even in that case you <strong><em>must</em></strong> perform the upgrade steps. To facilitate
different container runtimes, the architecture of <strong>Charmed Kubernetes</strong> has
changed slightly, and the container runtime is now part of a separate,
subordinate charm rather than being included in the <code class="highlighter-rouge">kubernetes-master</code> and
<code class="highlighter-rouge">kubernetes-worker</code> charms.</p>

<h3 id="to-keep-docker-as-the-container-runtime">To keep Docker as the container runtime</h3>

<p>Docker is currently installed on your kubernetes-worker units. The Docker subordinate
charm includes clean-up code to manage the transition to the new pluggable architecture.
To upgrade whilst retaining Docker as the runtime, you need to additionally deploy the new charm
and add relations to the master and worker components:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy cs:~containers/docker
juju add-relation docker kubernetes-master
juju add-relation docker kubernetes-worker
</code></pre></div></div>

<p>The upgrade is complete, and your worker nodes will continue to use the Docker runtime.
For information on configuring the Docker charm, see the <a href="https://jaas.ai/u/containers/docker#configuration">Docker configuration page</a>.</p>

<h3 id="to-migrate-to-containerd">To migrate to containerd</h3>

<p>If you intend to switch to containerd, it’s recommended that you first add some
temporary extra worker units. While not strictly necessary, skipping this step will result
in some cluster down time. Adding temporary additional workers provides a place for keeping pods running while new workers are brought online. The temporary workers can then be removed as the pods are migrated to the new workers. The rest of these instructions assume that you have deployed temporary workers.</p>

<h4 id="deploy-temporary-workers">Deploy temporary workers</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CURRENT_WORKER_REV</span><span class="o">=</span><span class="k">$(</span>juju status | <span class="nb">grep</span> <span class="s1">'^kubernetes-worker\s'</span> | <span class="nb">awk</span> <span class="s1">'{print $7}'</span><span class="k">)</span>
<span class="nv">CURRENT_WORKER_COUNT</span><span class="o">=</span><span class="k">$(</span>juju status | <span class="nb">grep</span> <span class="s1">'^kubernetes-worker/'</span> | <span class="nb">wc</span> <span class="nt">-l</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/^[ \t]*//'</span><span class="k">)</span>

juju deploy cs:~containers/kubernetes-worker-<span class="nv">$CURRENT_WORKER_REV</span>  kubernetes-worker-temp <span class="nt">-n</span> <span class="nv">$CURRENT_WORKER_COUNT</span>
</code></pre></div></div>

<h4 id="add-necessary-relations">Add necessary relations</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status <span class="nt">--relations</span> | <span class="nb">grep </span>worker: | <span class="nb">awk</span> <span class="s1">'{print $1,$2}'</span> | <span class="nb">sed</span> <span class="s1">'s/worker:/worker-temp:/g'</span> | xargs <span class="nt">-n2</span> juju relate
</code></pre></div></div>
<p>Wait for the temporary workers to become active before continuing.
Upgrade the master and worker charms:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm kubernetes-master
juju upgrade-charm kubernetes-worker
</code></pre></div></div>

<p>The kubernetes-worker units will enter a blocked state, with status message
“Connect a container runtime.”</p>

<h4 id="deploy-and-relate-the-new-docker-charm">Deploy and relate the new Docker charm</h4>

<p>This step is needed even if you do not intend to use Docker following the
upgrade. Docker is already installed on your <code class="highlighter-rouge">kubernetes-worker</code> units, and
the Docker subordinate includes clean-up code to uninstall Docker when the
Docker charm is replaced with the containerd charm.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy cs:~containers/docker
juju add-relation docker kubernetes-master
juju add-relation docker kubernetes-worker
</code></pre></div></div>

<h3 id="switching-to-containerd">Switching to Containerd</h3>

<p>Now, pause the existing workers, which will move pods to the temporary workers.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action <span class="o">[</span>unit] pause <span class="nt">--wait</span>
</code></pre></div></div>

<p>For example:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-worker/0 pause <span class="nt">--wait</span>
juju run-action kubernetes-worker/1 pause <span class="nt">--wait</span>
juju run-action kubernetes-worker/2 pause <span class="nt">--wait</span>
</code></pre></div></div>

<p>One-liner:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status | <span class="nb">grep</span> ^kubernetes-worker/ | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'*'</span> | xargs <span class="nt">-n1</span> <span class="nt">-I</span> <span class="s1">'{}'</span> juju run-action <span class="o">{}</span> pause <span class="nt">--wait</span>
</code></pre></div></div>

<h4 id="remove-docker">Remove Docker</h4>

<p>This will uninstall Docker from the workers.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju remove-relation docker kubernetes-master
juju remove-relation docker kubernetes-worker
juju remove-application docker
</code></pre></div></div>

<h4 id="deploy-containerd">Deploy Containerd</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy cs:~containers/containerd
juju add-relation containerd kubernetes-master
juju add-relation containerd kubernetes-worker
</code></pre></div></div>

<h4 id="resume-workers">Resume workers</h4>
<p>Now we can allow pods to be rescheduled to our original workers.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action <span class="o">[</span>unit] resume <span class="nt">--wait</span>
</code></pre></div></div>

<p>E.g.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-worker/0 resume <span class="nt">--wait</span>
juju run-action kubernetes-worker/1 resume <span class="nt">--wait</span>
juju run-action kubernetes-worker/2 resume <span class="nt">--wait</span>
</code></pre></div></div>

<p>One-liner:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status | <span class="nb">grep</span> ^kubernetes-worker/ | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'*'</span> | xargs <span class="nt">-n1</span> <span class="nt">-I</span> <span class="s1">'{}'</span> juju run-action <span class="o">{}</span> resume <span class="nt">--wait</span>
</code></pre></div></div>

<h4 id="cleanup">Cleanup</h4>

<p>You can now pause the temporary workers to force all pods to migrate back
to your “real” workers, then remove the temporary workers.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status | <span class="nb">grep</span> ^kubernetes-worker-temp/ | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'*'</span> | xargs <span class="nt">-n1</span> <span class="nt">-I</span> <span class="s1">'{}'</span> juju run-action <span class="o">{}</span> pause <span class="nt">--wait</span>

juju remove-application kubernetes-worker-temp
</code></pre></div></div>

<h4 id="mixing-containerd-and-docker">Mixing Containerd and Docker</h4>

<p>Once you have a Containerd backed Charmed Kubernetes running, you can add Docker backed
workers like so:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy cs:~containers/kubernetes-worker kubernetes-worker-docker
juju deploy cs:~containers/docker
juju relate docker kubernetes-worker-docker
</code></pre></div></div>

<h3 id="clusters-which-previously-ran-etcd-23">Clusters which previously ran etcd 2.3</h3>

<p>If your cluster has run etcd 2.3 at any point in the past, then it is
strongly recommended not to upgrade the etcd charm to revision 449. Doing so
will cause etcd to lose all of its data. For details, see
https://bugs.launchpad.net/charm-etcd/+bug/1843497</p>

<p>We recommend upgrading etcd directly to charm revision 460 instead.</p>

<p><a id="1.14"> </a></p>

<h2 id="upgrading-to-114">Upgrading to 1.14</h2>

<p>This upgrade includes support for <strong>CoreDNS 1.4.0</strong>. All new deployments of
<strong>Charmed Kubernetes</strong> will install <strong>CoreDNS</strong> by default instead of <strong>KubeDNS</strong>.</p>

<p>Existing deployments which are upgraded to <strong>Charmed Kubernetes 1.14</strong> will continue to use
<strong>KubeDNS</strong> until the operator chooses to upgrade to <strong>CoreDNS</strong>. To upgrade,
set the new dns-provider config:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master dns-provider<span class="o">=</span>core-dns
</code></pre></div></div>

<p>Please be aware that changing DNS providers will momentarily interrupt DNS
availability within the cluster. It is not necessary to recreate pods after the
upgrade completes.</p>

<p>The <code class="highlighter-rouge">enable-kube-dns</code> option has been removed to avoid confusion. The new
<code class="highlighter-rouge">dns-provider</code> option allows you to enable or disable <strong>KubeDNS</strong> as needed.</p>

<p>For more information on the new <code class="highlighter-rouge">dns-provider config</code>, see the
<a href="https://github.com/juju-solutions/kubernetes/blob/5f4868af82705a0636680a38d7f3ea760d35dadb/cluster/juju/layers/kubernetes-master/config.yaml#L58-L67">dns-provider config description</a>.</p>

<p><a id="1.10"> </a></p>

<h2 id="upgrading-from-19x-to-110x">Upgrading from 1.9.x to 1.10.x</h2>

<p>This upgrade includes a transistion between major versions of <strong>etcd</strong>, from 2.3 to 3.x. Between these releases, <strong>etcd</strong> changed the way it accesses storage, so it is necessary to reconfigure this. There is more detailed information on the change and the upgrade proceedure in the <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/upgrades/upgrade_3_0.md">upstream <strong>etcd</strong> documentation</a>.</p>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Caution:</span>
    This upgrade <strong>must</strong> be completed before attempting to upgrade the running cluster.
  </p>
</div>

<p>To make this upgrade more convenient for users of <strong>Charmed Kubernetes</strong>, a script has been prepared to manage the transition. The script can be <a href="https://raw.githubusercontent.com/juju-solutions/cdk-etcd-2to3/master/migrate">examined here</a>.</p>

<p>To use the script to update <strong>etcd</strong>, follow these steps:</p>

<h3 id="1-download-the-script-with-the-command">1. Download the script with the command:</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-O</span> https://raw.githubusercontent.com/juju-solutions/cdk-etcd-2to3/master/migrate
</code></pre></div></div>
<h3 id="2-make-the-script-executable">2. Make the script executable:</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x migrate
</code></pre></div></div>
<h3 id="3-execute-the-script">3. Execute the script:</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./migrate
</code></pre></div></div>
<h3 id="4-etcd-outputsed">4. etcd OutputSed</h3>

<p>The script should update <strong>etcd</strong> and you will see output similar to the following:</p>
<pre><code class="language-no-highlight">· Waiting for etcd units to be active and idle...
· Acquiring configured version of etcd...
· Upgrading etcd to version 3.0/stable from 2.3/stable.
· Waiting for etcd upgrade to 3.0/stable............................................................
· Waiting for etcd units to be active and idle....................................................
· Waiting for etcd cluster convergence...
· Stopping all Kubernetes api servers...
· Waiting for etcd cluster convergence...
· Stopping etcd...
· Migrating etcd/0...
· Migrating etcd/1...
· Migrating etcd/2...
· Starting etcd...
· Configuring storage-backend to etcd3...
· Waiting for all Kubernetes api servers to restart.......
· Done.
</code></pre>

<p>You can now proceed with the rest of the upgrade.</p>

<!--LINKS-->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/upgrade-notes.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
