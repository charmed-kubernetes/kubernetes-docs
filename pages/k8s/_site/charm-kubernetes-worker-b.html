<p>This charm deploys a container runtime, and additionally stands up the Kubernetes
worker applications: kubelet, and kube-proxy.</p>

<p>In order for this charm to be useful, it should be deployed with its companion
charm kubernetes-master and linked with an SDN-Plugin and a container runtime
such as containerd.</p>

<p>This charm has also been bundled up for your convenience so you can skip the
above steps, and deploy it with a single command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes
</code></pre></div></div>

<p>For more information about Charmed Kubernetes see the <a href="/kubernetes/docs/overview">overview documentation</a></p>

<h2 id="scale-out">Scale out</h2>

<p>To add additional compute capacity to your Kubernetes workers, you may
<code class="highlighter-rouge">juju add-unit</code> scale the cluster of applications. They will automatically
join any related kubernetes-master, and enlist themselves as ready once the
deployment is complete.</p>

<h2 id="snap-configuration">Snap Configuration</h2>

<p>The Kubernetes resources used by this charm are snap packages. When not
specified during deployment, these resources come from the public store. By
default, the snapd daemon will refresh all snaps installed from the store
four (4) times per day. A charm configuration option is provided for operators
to control this refresh frequency.</p>

<p>NOTE: this is a global configuration option and will affect the refresh
time for all snaps installed on a system.</p>

<h3 id="examples">Examples:</h3>

<h5 id="refresh-kubernetes-worker-snaps-every-tuesday">refresh kubernetes-worker snaps every tuesday</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-worker <span class="nv">snapd_refresh</span><span class="o">=</span><span class="s2">"tue"</span>
</code></pre></div></div>

<h5 id="refresh-snaps-at-11pm-on-the-last-5th-friday-of-the-month">refresh snaps at 11pm on the last (5th) friday of the month</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-worker <span class="nv">snapd_refresh</span><span class="o">=</span><span class="s2">"fri5,23:00"</span>
</code></pre></div></div>
<h5 id="delay-the-refresh-as-long-as-possible">delay the refresh as long as possible</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-worker <span class="nv">snapd_refresh</span><span class="o">=</span><span class="s2">"max"</span>
</code></pre></div></div>

<h5 id="use-the-system-default-refresh-timer">use the system default refresh timer</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-worker <span class="nv">snapd_refresh</span><span class="o">=</span><span class="s2">""</span>
</code></pre></div></div>

<p>For more information on the possible values for snapd_refresh, see the
refresh.timer section in the system options documentation.</p>

<h2 id="configuration">Configuration</h2>

<table>
  <thead>
    <tr>
      <th>property</th>
      <th>type</th>
      <th>default</th>
      <th>descrption</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>allow-privileged</td>
      <td>string</td>
      <td>True</td>
      <td>This option is now deprecated and has no effect.</td>
    </tr>
    <tr>
      <td>channel</td>
      <td>string</td>
      <td>1.17/stable</td>
      <td>Snap channel to install Kubernetes worker services from</td>
    </tr>
    <tr>
      <td>default-backend-image</td>
      <td>string</td>
      <td>auto</td>
      <td>Docker image to use for the default backend. Auto will select an image based on architecture.</td>
    </tr>
    <tr>
      <td>ingress</td>
      <td>boolean</td>
      <td>True</td>
      <td>Deploy the default http backend and ingress controller to handle ingress requests.</td>
    </tr>
    <tr>
      <td>ingress-ssl-chain-completion</td>
      <td>boolean</td>
      <td>False</td>
      <td><a href="#config-description-ingress-ssl-chain-completion">See notes</a></td>
    </tr>
    <tr>
      <td>ingress-ssl-passthrough</td>
      <td>boolean</td>
      <td>False</td>
      <td>Enable ssl passthrough on ingress server. This allows passing the ssl connection through to the workloads and not terminating it at the ingress controller.</td>
    </tr>
    <tr>
      <td>kubelet-extra-args</td>
      <td>string</td>
      <td><em>none</em></td>
      <td><a href="#config-description-kubelet-extra-args">See notes</a></td>
    </tr>
    <tr>
      <td>kubelet-extra-config</td>
      <td>string</td>
      <td>none</td>
      <td><a href="#config-description-kubelet-extra-config">See notes</a></td>
    </tr>
    <tr>
      <td>labels</td>
      <td>string</td>
      <td><em>none</em></td>
      <td>Labels can be used to organize and to select subsets of nodes in the cluster. Declare node labels in key=value format, separated by spaces.</td>
    </tr>
    <tr>
      <td>nagios_context</td>
      <td>string</td>
      <td>‘juju’</td>
      <td> </td>
    </tr>
    <tr>
      <td>nagios_servicesgroups</td>
      <td>string</td>
      <td> </td>
      <td>A comma-separated list of nagios servicegroups. If left empty, the nagios_context will be used as the servicegroup</td>
    </tr>
    <tr>
      <td>nginx-image</td>
      <td>string</td>
      <td>auto</td>
      <td>Docker image to use for the nginx ingress controller. Auto will select an image based on architecture.</td>
    </tr>
    <tr>
      <td>proxy-extra-args</td>
      <td>string</td>
      <td> </td>
      <td><a href="#config-description-kubelet-extra-args">See notes</a></td>
    </tr>
    <tr>
      <td>require-manual-upgrade</td>
      <td>boolean</td>
      <td>True</td>
      <td>When true, worker services will not be upgraded until the user triggers it manually by running the upgrade action.</td>
    </tr>
    <tr>
      <td>snap_proxy</td>
      <td>string</td>
      <td> </td>
      <td><strong>DEPRECATED</strong> Use snap-http-proxy and snap-https-proxy model configuration settings. HTTP/HTTPS web proxy for Snappy to use when accessing the snap store.</td>
    </tr>
    <tr>
      <td>snap_proxy_url</td>
      <td>string</td>
      <td> </td>
      <td><strong>DEPRECATED</strong> Use snap-store-proxy model configuration setting.</td>
    </tr>
    <tr>
      <td>snapd_refresh</td>
      <td>string</td>
      <td>max</td>
      <td><a href="#config-description-snapd_refresh">See notes</a></td>
    </tr>
    <tr>
      <td>sysctl</td>
      <td>string</td>
      <td><a href="#config-default-sysctl">See notes</a></td>
      <td><a href="#config-description-sysctl">See notes</a></td>
    </tr>
  </tbody>
</table>

<h3 id="ingress-ssl-chain-completion">ingress-ssl-chain-completion</h3>

<p><a id="config-description-ingress-ssl-chain-completion"> </a></p>

<h4 id="description">Description</h4>

<p>Enable chain completion for TLS certificates used by the nginx ingress
controller.  Set this to true if you would like the ingress controller
to attempt auto-retrieval of intermediate certificates.  The default
(false) is recommended for all production kubernetes installations, and
any environment which does not have outbound Internet access.</p>

<h3 id="kubelet-extra-args">kubelet-extra-args</h3>

<p><a id="config-description-kubelet-extra-args"> </a></p>
<h4 id="description-1">Description</h4>

<p>Space separated list of flags and key=value pairs that will be passed as arguments to
kubelet. For example a value like this:
  runtime-config=batch/v2alpha1=true profiling=true
will result in kubelet being run with the following options:
  –runtime-config=batch/v2alpha1=true –profiling=true
Note: As of Kubernetes 1.10.x, many of Kubelet’s args have been deprecated, and can
be set with kubelet-extra-config instead.</p>

<hr />

<h3 id="kubelet-extra-config">kubelet-extra-config</h3>

<p><a id="config-description-kubelet-extra-config"> </a></p>
<h4 id="description-2">Description</h4>

<p>Extra configuration to be passed to kubelet. Any values specified in this
config will be merged into a KubeletConfiguration file that is passed to
the kubelet service via the –config flag. This can be used to override
values provided by the charm.</p>

<p>Requires Kubernetes 1.10+.</p>

<p>The value for this config must be a YAML mapping that can be safely
merged with a KubeletConfiguration file. For example:
<code class="highlighter-rouge">{evictionHard: {memory.available: 200Mi}}</code></p>

<p>For more information about KubeletConfiguration, see upstream docs:
<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/">https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/</a></p>

<hr />

<h3 id="nagios_context">nagios_context</h3>

<p><a id="config-description-nagios_context"> </a></p>
<h4 id="description-3">Description</h4>

<p>Used by the nrpe subordinate charms.
A string that will be prepended to instance name to set the host name
in nagios. So for instance the hostname would be something like:
<code class="highlighter-rouge">juju-myservice-0</code></p>

<p>If you’re running multiple environments with the same services in them
this allows you to differentiate between them.</p>

<hr />

<h3 id="proxy-extra-args">proxy-extra-args</h3>

<p><strong>Type</strong>: string     <strong>Default</strong>:</p>

<p><a id="config-description-kubelet-extra-args"> </a>
Space separated list of flags and key=value pairs that will be passed as arguments to
kube-proxy. For example a value like this:
  <code class="highlighter-rouge">runtime-config=batch/v2alpha1=true profiling=true</code>
will result in kube-apiserver being run with the following options:
  <code class="highlighter-rouge">--runtime-config=batch/v2alpha1=true --profiling=true</code></p>

<hr />

<h3 id="snapd_refresh">snapd_refresh</h3>

<p><a id="config-description-snapd_refresh"> </a></p>

<p>How often snapd handles updates for installed snaps. Setting an empty
string will check 4x per day. Set to “max” to delay the refresh as long
as possible. You may also set a custom string as described in the
‘refresh.timer’ section here:
<a href="https://forum.snapcraft.io/t/system-options/87">https://forum.snapcraft.io/t/system-options/87</a></p>

<hr />

<h3 id="sysctl">sysctl</h3>

<p><a id="config-default-sysctl"> </a></p>
<h4 id="default">Default</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> { net.ipv4.conf.all.forwarding : 1, net.ipv4.neigh.default.gc_thresh1 : 128, net.ipv4.neigh.default.gc_thresh2 : 28672, net.ipv4.neigh.default.gc_thresh3 : 32768, net.ipv6.neigh.default.gc_thresh1 : 128, net.ipv6.neigh.default.gc_thresh2 : 28672, net.ipv6.neigh.default.gc_thresh3 : 32768, fs.inotify.max_user_instances : 8192, fs.inotify.max_user_watches: 1048576 }
</code></pre></div></div>
<p><a id="config-description-sysctl"> </a></p>

<h4 id="description-4">Description</h4>
<p>YAML formatted associative array of sysctl values, e.g.:
‘{kernel.pid_max : 4194303 }’. Note that kube-proxy handles
the conntrack settings. The proper way to alter them is to
use the proxy-extra-args config to set them, e.g.:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  juju config kubernetes-master proxy-extra-args="conntrack-min=1000000 conntrack-max-per-core=250000"
  juju config kubernetes-worker proxy-extra-args="conntrack-min=1000000 conntrack-max-per-core=250000"
</code></pre></div></div>
<p>The proxy-extra-args conntrack-min and conntrack-max-per-core can be set to 0 to ignore
kube-proxy’s settings and use the sysctl settings instead. Note the fundamental difference between
the setting of conntrack-max-per-core vs nf_conntrack_max.</p>

<hr />

<!-- CONFIG ENDS -->

<h2 id="operational-actions">Operational actions</h2>

<p>The kubernetes-worker charm supports the following Operational Actions:</p>

<h3 id="pause">Pause</h3>

<p>Pausing the workload enables administrators to both drain and cordon
a unit for maintenance.</p>

<h3 id="resume">Resume</h3>

<p>Resuming the workload will uncordon a paused unit. Workloads will automatically
migrate unless otherwise directed via their application declaration.</p>

<h2 id="relations">Relations</h2>

<ul class="p-list">


                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=aws-integration">aws: aws-integration</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=azure-integration">azure: azure-integration</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=tls-certificates">certificates: tls-certificates</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=docker-registry">docker-registry: docker-registry</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=gcp-integration">gcp: gcp-integration</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=http">kube-api-endpoint: http</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=kube-control">kube-control: kube-control</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=kube-dns">kube-dns: kube-dns</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=mount">nfs: mount</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=openstack-integration">openstack: openstack-integration</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?provides=vsphere-integration">vsphere: vsphere-integration</a>
                </li>




                <li class="p-list__item">
                  <a href="https://jaas.ai/search?requires=kubernetes-cni">cni: kubernetes-cni</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?requires=container-runtime">container-runtime: container-runtime</a>
                </li>

                <li class="p-list__item">
                  <a href="https://jaas.ai/search?requires=nrpe-external-master">nrpe-external-master: nrpe-external-master</a>
                </li>


          </ul>

<h2 id="faq">FAQ</h2>
