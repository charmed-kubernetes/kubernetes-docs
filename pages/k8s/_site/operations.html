<p>Now that you have installed your <strong>Charmed Kubernetes</strong> cluster, what can you do with it? This page details
some basic cluster operations, including how to check the status of your cluster and test
that it is working with the built-in demo deployment.</p>

<p>If you are already familiar with this, you may still like to check out the <a href="#next">Next steps</a>
for more useful guides on operating Kubernetes.</p>

<h2 id="install-and-configure-kubectl">Install and configure kubectl</h2>

<p>You will need <strong>kubectl</strong> to be able to use your Kubernetes cluster. If it is not already
installed (it is automatically installed if you used conjure-up to deploy <strong>Charmed Kubernetes</strong>), it is easy
to add via a snap package:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>snap <span class="nb">install </span>kubectl <span class="nt">--classic</span>
</code></pre></div></div>

<p>For other platforms and install methods, please see the
<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Kubernetes documentation</a>.</p>

<p>The config file for accessing the newly deployed cluster is stored in the cluster itself and will be available
as soon as the installation has settled. You should use the following command to retrieve it (create a
<strong>.kube</strong> directory if it was not created after kubectl installation):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju scp kubernetes-master/0:config ~/.kube/config
</code></pre></div></div>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Caution:</span>
If you have multiple clusters you will need to manage the config file rather than just
replacing it. See the <a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">
Kubernetes documentation</a> for more information on managing multiple clusters.
  </p>
</div>

<p>You can verify that kubectl is configured correctly and can see the cluster by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl cluster-info
</code></pre></div></div>

<p>Now you can run pods inside the Kubernetes cluster:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> example.yaml
</code></pre></div></div>

<p>List all pods in the cluster:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<p>List all services in the cluster:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services
</code></pre></div></div>

<h2 id="accessing-the-kubernetes-dashboard">Accessing the Kubernetes dashboard</h2>

<p>To check that everything is actually working, you may want to log in to the Kubernetes Dashboard.</p>

<p>The recommended way to do this is to use the built-in proxy service, run with the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl proxy
</code></pre></div></div>

<p>The URL for the dashboard will then be <a href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</a></p>

<p>For versions prior to 1.16, the dashboard URL will be <a href="http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/">http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a>.</p>

<p>Open a browser at the address for the Dashboard. You will see an authentication screen:</p>

<p><img src="https://assets.ubuntu.com/v1/80980265-dashboard_login.png" alt="dashboard image" /></p>

<p>You will need to log in to the Dashboard with a valid user. The easiest thing to do is to
select your kubeconfig file, but for future administration, you should set up
<em>role based access control</em>.</p>

<p><img src="https://assets.ubuntu.com/v1/37ee63d6-CDK-008.png" alt="dashboard image" /></p>

<h2 id="using-ingress">Using Ingress</h2>

<p>The kubernetes-worker charm supports deploying an NGINX ingress controller.
Ingress allows access from the Internet to containers running web
services inside the cluster.</p>

<p>First allow the Internet access to the kubernetes-worker charm with with the
following Juju command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju expose kubernetes-worker
</code></pre></div></div>

<p>In Kubernetes, workloads are declared using pod, service, and ingress
definitions. An ingress controller is provided to you by default and deployed into
the <a href="https://kubernetes.io/docs/user-guide/namespaces/">default namespace</a> of the
cluster. If one is not available, you may deploy it with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-worker ingress=true
</code></pre></div></div>

<p>Ingress resources are DNS mappings to your containers, routed through
<a href="https://kubernetes.io/docs/user-guide/services/">endpoints</a>.</p>

<h2 id="configuring-dns">Configuring DNS</h2>

<p>Charmed Kubernetes 1.14+ has CoreDNS enabled by default, which allows pods within Kubernetes
to communicate with other pods or services by name.</p>

<p>If you would like to disable DNS (for example, to deploy your own custom DNS
solution), you can use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master dns-provider<span class="o">=</span>none
</code></pre></div></div>

<p>To deploy a customised DNS configuration, first disable the charm-managed DNS
provider (see above). After deploying your DNS pods, don’t forget to configure
kubelet with the IP of your DNS service:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-worker kubelet-extra-config<span class="o">=</span><span class="s2">"{clusterDNS: ['10.152.183.123']}"</span>
</code></pre></div></div>

<h2 id="running-the-packaged-example">Running the packaged example</h2>

<p>As an example for users unfamiliar with Kubernetes, we packaged an action to
both deploy an example and clean itself up.</p>

<p>This action performs the following steps:</p>

<ul>
  <li>
    <p>It creates a deployment titled ‘microbots’ comprised of a number of replicas defined
during the run of the action.</p>
  </li>
  <li>
    <p>It also creates a service named ‘microbots’ which binds an ‘endpoint’, using all  of
the ‘microbots’ pods.</p>
  </li>
  <li>
    <p>Finally, it will create an ingress resource, which points at a
<a href="https://xip.io">xip.io</a> domain to simulate a proper DNS service.</p>
  </li>
</ul>

<p>To deploy 3 replicas of the microbot web application inside the Kubernetes
cluster run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-worker/0 microbot <span class="nv">replicas</span><span class="o">=</span>3 <span class="nt">--wait</span>
</code></pre></div></div>

<p>This should result, after a few moments, in output similar to the following (Your FQDN
will be different and contain the address of the cloud instance.)</p>

<pre><code class="language-YAML">id: 4d4a2245-e544-45d1-886d-b828ccf72c47
  results:
    address: microbot.52.87.186.136.xip.io
  status: completed
  timing:
    completed: 2019-03-22 15:00:39 +0000 UTC
    enqueued: 2019-03-22 15:00:34 +0000 UTC
    started: 2019-03-22 15:00:37 +0000 UTC
  unit: kubernetes-worker/0
</code></pre>

<p>At this point, you can inspect the cluster to observe the workload coming
online.</p>

<h3 id="list-the-pods">List the pods</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    NAME                        READY   STATUS    RESTARTS   AGE
    microbot-5b9864df4d-q7b94   1/1     Running   0          2m31s
    microbot-5b9864df4d-rx9b2   1/1     Running   0          2m31s
    microbot-5b9864df4d-x7ppr   1/1     Running   0          2m31s
</code></pre></div></div>

<h3 id="list-the-services-and-endpoints">List the services and endpoints</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services,endpoints
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.152.183.1    &lt;none&gt;        443/TCP   112m
service/microbot     ClusterIP   10.152.183.62   &lt;none&gt;        80/TCP    3m50s

NAME                   ENDPOINTS                                   AGE
endpoints/kubernetes   10.95.195.54:6443                           112m
endpoints/microbot     10.1.77.12:80,10.1.77.13:80,10.1.77.14:80   3m50s

</code></pre></div></div>

<h3 id="list-the-ingress-resources">List the ingress resources</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get ingress
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME               HOSTS                           ADDRESS   PORTS   AGE
microbot-ingress   microbot.52.87.186.136.xip.io             80      5m36s
</code></pre></div></div>

<p>When all the pods are listed as Running, you are ready to visit the address listed in the
HOSTS column of the ingress listing.</p>

<div class="p-notification--positive">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
It is normal to see a 502/503 error during initial application deployment
  </p>
</div>

<p>As you refresh the page, you will be greeted with a microbot web page, serving
from one of the microbot replica pods. Refreshing will show you another
microbot with a different hostname as the requests are load-balanced across
the replicas.</p>

<h3 id="clean-up-example">Clean up example</h3>

<p>There is also an action to clean up the microbot applications. When you are
done using the microbot application you can delete them from the pods with
one Juju action:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-worker/0 microbot <span class="nv">delete</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<p>If you no longer need Internet access to your workers, remember to unexpose the
kubernetes-worker charm:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju unexpose kubernetes-worker
</code></pre></div></div>

<p>To learn more about
<a href="https://kubernetes.io/docs/user-guide/ingress.html">Kubernetes Ingress</a>
and how to configure the Ingress Controller beyond defaults (such as TLS and
websocket support) view the
<a href="https://github.com/kubernetes/contrib/tree/master/ingress/controllers/nginx">nginx-ingress-controller</a>
project on github.</p>

<p><a id="next"> </a></p>

<h2 id="next-steps">Next steps</h2>

<p>Now that your <strong>Charmed Kubernetes</strong> cluster is up and running, here are some suggestions for additional
things you may wish to try:</p>

<ul>
  <li><a href="/kubernetes/docs/storage">Adding Storage</a></li>
  <li><a href="/kubernetes/docs/scaling">Scaling your cluster</a></li>
  <li><a href="/kubernetes/docs/logging">Examining logs</a></li>
  <li><a href="/kubernetes/docs/decommissioning">Decommissioning the cluster</a></li>
  <li>Need help or want to chat? <a href="/kubernetes/docs/get-in-touch">Get in touch!</a></li>
</ul>

<h2 id="additional-resources">Additional Resources</h2>

<ul>
  <li><a href="https://kubernetes.io/docs/user-guide/">Kubernetes User Guide</a></li>
  <li><a href="https://jujucharms.com/charmed-kubernetes/">The Charmed Distribution of Kubernetes</a></li>
  <li><a href="https://api.jujucharms.com/charmstore/v5/charmed-kubernetes-3/archive/bundle.yaml?channel=stable">Bundle source</a></li>
  <li><a href="https://bugs.launchpad.net/charmed-kubernetes">Bug tracker</a></li>
</ul>

<!--LINKS-->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/operations.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
