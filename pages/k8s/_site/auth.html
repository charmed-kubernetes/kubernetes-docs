<p><strong>Charmed Kubernetes</strong> implements access
control based on the Kubernetes model. A complete overview of the Kubernetes
authorisation  system is given in the <a href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/">Kubernetes Documentation</a>.
This page provides summary information on the available modes and how to configure
<strong>Charmed Kubernetes</strong> to use them.</p>

<p>The following modes are supported:</p>

<ul>
  <li><strong>AlwaysAllow</strong>: This is the default mode. All calls to the API server are allowed.</li>
  <li><strong>Node</strong>: Grants permissions to kubelets based on the pods they are scheduled to run.
 When using this mode, <strong>Charmed Kubernetes</strong> will enable <code class="highlighter-rouge">NodeRestriction</code> and will issue (and
 decommission) tokens for kubernetes-workers as you scale your infrastructure.
 More detailed information can be found in the <a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">Kubernetes documentation</a>.</li>
  <li><strong>ABAC</strong>: Using attribute-based access control, access rights are granted to users
 through the use of policies which combine attributes together. The policies can use any
 type of attributes (user attributes, resource attributes, object attributes, environment
 attributes, etc). For more information on ABAC mode, see the
 <a href="https://kubernetes.io/docs/reference/access-authn-authz/abac/">Kubernetes ABAC documentation</a>.</li>
  <li><strong>RBAC</strong>:  Using role-based access control, access is granted to users based on the
roles assigned to them. This mode expects respective roles and bindings to be available
for any running services. <strong>Charmed Kubernetes</strong> already has roles and bindings ready for use
(<a href="#rbac">see below</a>).</li>
  <li><strong>Webhook</strong>:  With this mode set, Kubernetes will query an outside REST service
when determining user privileges. This mode requires additional configuration to
specify the service being queried. A full explanation of this can be found in the
<a href="https://kubernetes.io/docs/reference/access-authn-authz/webhook/">Kubernetes Webhook mode documentation</a>.</li>
  <li><strong>AlwaysDeny</strong>: This mode denies all API requests - it is only really useful for testing.</li>
</ul>

<h2 id="determining-the-current-configuration">Determining the current configuration</h2>

<p>Juju can be used to query the current configuration setting:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master authorization-mode
</code></pre></div></div>

<p>The default value is:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AlwaysAllow
</code></pre></div></div>

<p>For further verification, the runtime arguments for the <code class="highlighter-rouge">kube-apiserver</code> can be determined:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run <span class="nt">--unit</span> kubernetes-master/0 <span class="s2">"ps -ef | grep apiserver"</span>
</code></pre></div></div>

<p>… from which we can see the <code class="highlighter-rouge">--authorization-mode=AlwaysAllow</code> argument:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root      2013     1  2 11:18 ?        00:01:25 /snap/kube-apiserver/917/kube-apiserver --advertise-address=10.153.234.96 --min-request-timeout=300 --etcd-cafile=/root/cdk/etcd/client-ca.pem --etcd-certfile=/root/cdk/etcd/client-cert.pem --etcd-keyfile=/root/cdk/etcd/client-key.pem --etcd-servers=https://10.154.124.144:2379,https://10.165.213.59:2379,https://10.167.80.201:2379 --storage-backend=etcd3 --tls-cert-file=/root/cdk/server.crt --tls-private-key-file=/root/cdk/server.key --insecure-bind-address=127.0.0.1 --insecure-port=8080 --audit-log-maxbackup=9 --audit-log-maxsize=100 --audit-log-path=/root/cdk/audit/audit.log --audit-policy-file=/root/cdk/audit/audit-policy.yaml --basic-auth-file=/root/cdk/basic_auth.csv --client-ca-file=/root/cdk/ca.crt --requestheader-allowed-names=system:kube-apiserver --requestheader-client-ca-file=/root/cdk/ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --service-account-key-file=/root/cdk/serviceaccount.key --token-auth-file=/root/cdk/known_tokens.csv --authorization-mode=AlwaysAllow --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota --allow-privileged=false --enable-aggregator-routing --kubelet-certificate-authority=/root/cdk/ca.crt --kubelet-client-certificate=/root/cdk/client.crt --kubelet-client-key=/root/cdk/client.key --kubelet-preferred-address-types=[InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP] --proxy-client-cert-file=/root/cdk/client.crt --proxy-client-key-file=/root/cdk/client.key --service-cluster-ip-range=10.152.183.0/24 --logtostderr --v=4
root     18966 18964  0 12:11 ?        00:00:00 grep apiserver
</code></pre></div></div>

<h2 id="setting-a-configuration">Setting a configuration</h2>

<p>The authorisation mode can be set using the same <strong>Juju</strong> command as above, but this
time specifying a value:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master authorization-mode<span class="o">=</span><span class="s2">"Node"</span>
</code></pre></div></div>

<p>It is possible to set more than one mode using a comma-separated list:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master authorization-mode<span class="o">=</span><span class="s2">"RBAC, Node"</span>
</code></pre></div></div>

<div class="p-notification--positive"><p class="p-notification__response">
<span class="p-notification__status">Note:</span>
Using “RBAC,Node” for authorisation is the recommended configuration.
</p></div>

<p>The order matters. Kubernetes will process each API request with each module in
sequence. If the current authorising module either allows or denies the
request, that decision is made and no further modules are consulted. If the
current module has no opinion on the request, then the decision is passed to
the next module in the list. If no decision has been returned by the last
module in the list, then the request is denied.</p>

<p><a id="rbac"> </a></p>

<h2 id="further-information-on-rbac">Further information on RBAC</h2>

<p>Many of the defined roles (those prefixed by ‘system:’ ) for RBAC are really intended for
managing access to Kubernetes componenets themselves.</p>

<p>The main  cluster roles for additional users are:<code class="highlighter-rouge">admin</code>, <code class="highlighter-rouge">cluster-admin</code>, <code class="highlighter-rouge">edit</code> and <code class="highlighter-rouge">view</code> .</p>

<p>You can view the available roles,  cluster roles and bindings with the following commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get roles <span class="nt">--all-namespaces</span>
kubectl get clusterroles <span class="nt">--all-namespaces</span>
kubectl get rolebindings <span class="nt">--all-namespaces</span>
kubectl get clusterrolebindings  <span class="nt">--all-namespaces</span>
</code></pre></div></div>

<h3 id="adding-or-removing-users-and-editing-roles">Adding or removing users and editing roles</h3>

<p>The recommended method for managing Kubernetes users is through an external
authentication service such as LDAP (see the documentation on
<a href="/kubernetes/docs/ldap">using LDAP with CDK</a>). You can read more about the Kubernetes
approach to authentication in this page of the
<a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/">Kubernetes documentation</a>.</p>

<p>For simple systems, and for the purposes of testing, it can be useful to use the basic
file-based system. The instructions below demonstrate how to edit the <code class="highlighter-rouge">basic_auth.csv</code>
files on the <code class="highlighter-rouge">kubernetes-master</code> nodes.</p>

<h4 id="using-basic_auth-files">Using <code class="highlighter-rouge">basic_auth</code> files</h4>

<p>To add a user you will need to edit the /root/cdk/basic_auth.csv. Note that the
format for this file is password,user,uid,”group1,group2,group3”.</p>

<p>First establish an SSH connection to the main kubernetes-master:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju ssh kubernetes-master/0
</code></pre></div></div>

<p>Then edit the file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /root/cdk/basic_auth.csv
<span class="nb">exit</span>
</code></pre></div></div>
<p>…adding the appropriate details. You can then restart the master for the changes to take
effect:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-master/0 restart
</code></pre></div></div>

<p>For more detail on the roles and bindings, please see the
<a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Kubernetes RBAC documentation</a>.</p>

<h3 id="using-aws-iam-with-rbac">Using AWS IAM with RBAC</h3>

<p>AWS IAM credentials can be used for authentication and authorisation on your Charmed Kubernetes cluster, even if the cluster is not hosted on AWS. For further details see the documentation on <a href="/kubernetes/docs/aws-iam-auth">AWS IAM auth</a>.</p>

<p><!-- LINKS --></p>

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/auth.md" class="p-notification__action">edit this page</a>
    or
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
