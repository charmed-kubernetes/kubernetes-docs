<p>The standard deployment of <strong>Charmed Kubernetes</strong> includes a single instance
of the kube-api-loadbalancer. For many use cases this is perfectly adequate,
but in a production environment you should be keen to eliminate any single
point of failure.</p>

<p>The recommended way to provide a failover for the kube-api-loadbalancer is by
using <a href="http://www.keepalived.org/">keepalived</a>. This is available as a <strong>Juju</strong> charm and
can be deployed into your <strong>Charmed Kubernetes</strong> model and configured as
follows:</p>

<ol>
  <li>Deploy the <code class="highlighter-rouge">keepalived</code> charm:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> juju deploy cs:~containers/keepalived
</code></pre></div>    </div>
  </li>
  <li>Add the required relations :
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> juju add-relation keepalived:juju-info kubeapi-load-balancer:juju-info
 juju add-relation keepalived:lb-sink kubeapi-load-balancer:website
 juju add-relation keepalived:loadbalancer kubernetes-master:loadbalancer
 juju add-relation keepalived:website kubernetes-worker:kube-api-endpoint
</code></pre></div>    </div>
    <p>This redirects both the Kubernetes master and worker units to point at the keepalived
 service rather than the api-endpoint directly.</p>
  </li>
  <li>Configure the keepalived application. You should substitute a suitable IP address and
  FQDN in the example below:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">VIP_HOSTNAME</span><span class="o">=</span>test.example.com
 juju config keepalived <span class="nv">virtual_ip</span><span class="o">=</span>10.10.74.250
 juju config keepalived <span class="nv">port</span><span class="o">=</span>443
 juju config keepalived <span class="nv">vip_hostname</span><span class="o">=</span><span class="nv">$VIP_HOSTNAME</span>
</code></pre></div>    </div>
  </li>
  <li>Add the new hostname to the API server certificate. This is done by specifying an
additional <a href="https://www.openssl.org/docs/manmaster/man5/x509v3_config.html#Subject-Alternative-Name">SAN</a>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubeapi-load-balancer <span class="nv">extra_sans</span><span class="o">=</span><span class="nv">$VIP_HOSTNAME</span>
juju config kubernetes-master <span class="nv">extra_sans</span><span class="o">=</span><span class="nv">$VIP_HOSTNAME</span>
</code></pre></div>    </div>
  </li>
  <li>Wait for the new service to settle. You can check the status of the <code class="highlighter-rouge">keepalived</code>
 application by running:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> juju status keepalived
</code></pre></div>    </div>
    <p>Once the application reports a ‘ready’ status, continue to the next step.</p>
  </li>
  <li>Remove unneeded relations:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> juju remove-relation kubernetes-worker:kube-api-endpoint kubeapi-load-balancer:website
 juju remove-relation kubernetes-master:loadbalancer kubeapi-load-balancer:loadbalancer
</code></pre></div>    </div>
  </li>
  <li>Scale up the <code class="highlighter-rouge">kubeapi-load-balancer</code>. You can specify as many units as your situation requires.
 In this example, we add two additional units for a total of three:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> juju add-unit kubeapi-load-balancer <span class="nt">-n</span> 2
</code></pre></div>    </div>
  </li>
</ol>

<p>Note that the <code class="highlighter-rouge">keepalived</code> application is a
<a href="https://docs.jujucharms.com/stable/en/authors-subordinate-applications"><em>subordinate charm</em></a> - it does not require a machine of its
own to run on, but rather runs alongside the <code class="highlighter-rouge">kubeapi-load-balancer</code> charm. If
for any reason you need to <a href="/kubernetes/docs/logging">view logs</a> or troubleshoot this
application, it will be found co-located on the machines running the load
balancer.</p>

<!--LINKS-->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/keepalived.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
