<p><strong>Charmed Kubernetes</strong> supports GPU-enabled
instances for applications which can use them. The kubernetes-worker charm will
automatically detect NVIDIA hardware and enable the appropriate support.
However, the implementation of GPU-enabled instances differs greatly between
public clouds. This page outlines the recommended methods for running GPU
enabled hardware for different public clouds.</p>

<h3 id="deploying-charmed-kubernetes-with-gpu-workers-on-aws">Deploying Charmed Kubernetes with GPU workers on AWS</h3>

<p>If you are installing Charmed Kubernetes using a bundle, you can use constraints to specify
that the worker units are deployed on GPU-enabled machines. Because GPU support
varies considerably depending on the underlying cloud, this requires specifying
a particular instance type.</p>

<p>This can be done with a YAML overlay file. For example, when deploying Charmed
Kubernetes on AWS, you may decide you wish to use AWS’s ‘p2.xlarge’ instances
(you can check the AWS instance definitions on the
<a href="https://aws.amazon.com/ec2/instance-types/">AWS website</a>). A YAML overlay file can be constructed like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#gpu-overlay.yaml</span>
<span class="na">applications</span><span class="pi">:</span>
  <span class="na">kubernetes-worker</span><span class="pi">:</span>
    <span class="na">constraints</span><span class="pi">:</span> <span class="s">instance-type=p2.xlarge</span>
</code></pre></div></div>

<p>And then deployed with Charmed Kubernetes like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes <span class="nt">--overlay</span> ~/path/aws-overlay.yaml <span class="nt">--overlay</span> ~/path/gpu-overlay.yaml
</code></pre></div></div>

<p>As demonstrated here, you can use multiple overlay files when deploying, so you
can combine GPU support with an integrator charm or other custom configuration.</p>

<p>You may then want to <a href="#test">test a GPU workload</a></p>

<h3 id="adding-gpu-workers-with-aws">Adding GPU workers with AWS</h3>

<p>It isn’t necessary for all the worker units to have GPU support. You can simply
add GPU-enabled workers to a running cluster. The recommended way to do this is
to first create a new constraint for the kubernetes-worker:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju set-constraints kubernetes-worker instance-type<span class="o">=</span>p2.xlarge
</code></pre></div></div>

<p>Then you can add as many new worker units as required. For example, to add two
new units.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju add-unit kubernetes-worker <span class="nt">-n2</span>
</code></pre></div></div>

<h3 id="adding-gpu-workers-with-gcp">Adding GPU workers with GCP</h3>

<p>Google supports GPUs slightly differently to most clouds. There are no GPUs
included in any of the default instance templates, and therefore they have
to be added manually.</p>

<p>To begin, add a new machine with Juju. Include any desired constraints for
memory,cores,etc :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju add-machine <span class="nt">--constraints</span> <span class="nv">cores</span><span class="o">=</span>2
</code></pre></div></div>

<p>The command will return, telling you the number of the machine that was
created - keep a note of this number.</p>

<p>Next you will need to use the gcloud tool or the GCP console to stop the
instance, edit its configuration and then restart the machine.</p>

<p>Once it is up and running, you can then add it as a worker:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju add-unit kubernetes-worker <span class="nt">--to</span> 10
</code></pre></div></div>

<p>…replacing ‘10’ in the above with the number of the machine you created.</p>

<p>As the charm installs, the GPU will be detected and the relevant drivers will
also be installed.
<a id="test"> </a></p>

<h2 id="testing">Testing</h2>

<p>As GPU instances can be costly, it is useful to test that they can actually be
used. A simple test job can be created to run NVIDIA’s hardware reporting tool.</p>

<p>This can also be <a href="https://raw.githubusercontent.com/juju-solutions/kubernetes-docs/master/assets/nvidia-test.yaml">downloaded here</a>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nvidia-smi</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">nvidia-smi</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nvidia/cuda</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">nvidia-smi</span>
        <span class="na">args</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">nvidia-smi</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="s">nvidia.com/gpu</span><span class="pi">:</span> <span class="s">1</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="s">nvidia.com/gpu</span><span class="pi">:</span> <span class="s">1</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/usr/bin/</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">binaries</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/usr/lib/x86_64-linux-gnu</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">libraries</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">binaries</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/usr/bin/</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">libraries</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/usr/lib/x86_64-linux-gnu</span>

</code></pre></div></div>

<p>Download the file and run it with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> nvidia-test.yaml
</code></pre></div></div>

<p>If you then check the Kubernetes dashboard, you can inspect the logs to
find the hardware report.</p>

<p><img src="https://assets.ubuntu.com/v1/2ba88cee-nvidia.png" alt="dashboard image" /></p>

<!-- IMAGES -->

<!-- LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/gpu-workers.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
