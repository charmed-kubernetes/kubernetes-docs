<p>Charms that comprise <strong>Charmed Kubernetes</strong> install required software such
as <code class="highlighter-rouge">etcd</code>, <code class="highlighter-rouge">kubelet</code>, and <code class="highlighter-rouge">kube-apiserver</code> using snap packages. The <code class="highlighter-rouge">snapd</code>
daemon periodically scans installed snaps for updates and will automatically
refresh upgradeable packages to ensure the software is current.</p>

<p>All charms built from <a href="https://git.launchpad.net/layer-snap">layer-snap</a> include a <code class="highlighter-rouge">snapd_refresh</code> configuration
option that can be used to adjust the <code class="highlighter-rouge">snapd</code> refresh interval. By default,
<strong>Charmed Kubernetes</strong> charms set this option to the maximum amount of time
that <code class="highlighter-rouge">snapd</code> will allow between scans.</p>

<h2 id="refresh-interval-configuration">Refresh interval configuration</h2>

<p>Display the currently configured <code class="highlighter-rouge">snapd_refresh</code> option for a given charm:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config &lt;charm&gt; snapd_refresh
</code></pre></div></div>

<p>Change the <code class="highlighter-rouge">snapd_refresh</code> option with the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config &lt;charm&gt; <span class="nv">snapd_refresh</span><span class="o">=</span>&lt;value&gt;
</code></pre></div></div>

<p>The value returned or set above should be an explicit timer, an empty string,
or the special keyword <em>max</em>.</p>

<ul>
  <li>
    <p>Explicit timer</p>

    <p>An explicit timer may be a simple <code class="highlighter-rouge">mon</code> (scan every Monday) or a more
  complex <code class="highlighter-rouge">mon3,23:00</code> (scan on the third Monday of the month at 23:00). See
  possible values for explicit timers in the the <em>refresh.timer</em> section of
  the <a href="https://forum.snapcraft.io/t/system-options/87">system options</a> documentation.</p>
  </li>
  <li>
    <p>Empty string</p>

    <p>An empty string instructs <code class="highlighter-rouge">snapd</code> to refresh snap packages according to the
  default system policy. This is currently 4 times per day.</p>
  </li>
  <li>
    <p><em>max</em></p>

    <p>When set to <code class="highlighter-rouge">max</code>, refresh scans will be delayed for the maximum amount of
  time allowed by <code class="highlighter-rouge">snapd</code>. This is currently once per month based on the
  date this option was set.</p>
  </li>
</ul>

<h3 id="determine-the-actual-max-value">Determine the actual <em>max</em> value</h3>

<p>Use <code class="highlighter-rouge">snap get</code> on a deployed system to determine the value that <code class="highlighter-rouge">snapd</code> uses
when a charm is configured with <code class="highlighter-rouge">snapd_refresh=max</code>. An example with <code class="highlighter-rouge">etcd</code>
shows that the <code class="highlighter-rouge">max</code> option used when <code class="highlighter-rouge">etcd/0</code> was deployed has mapped to the
last Sunday of every month (<code class="highlighter-rouge">sun5</code>):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config etcd snapd_refresh
max
juju run <span class="nt">--unit</span> etcd/0 <span class="s1">'snap get system refresh.timer'</span>
sun5
</code></pre></div></div>

<h2 id="refresh-interval-among-peers">Refresh interval among peers</h2>

<p><strong>Charmed Kubernetes</strong> applications that support peering will use <strong>Juju</strong>
leadership to configure a consistent refresh interval among peers. The lead
unit for <code class="highlighter-rouge">etcd</code>, <code class="highlighter-rouge">kubernetes-master</code>, and <code class="highlighter-rouge">kubernetes-worker</code> applications
will set an initial refresh value. Subsequent units that join as followers
will use the leader value as their snap refresh interval. This ensures all
units in a peer group will refresh at approximately the same time.</p>

<h2 id="force-snapd-to-refresh-installed-snaps">Force snapd to refresh installed snaps</h2>

<p>If an immediate snap refresh is desired, invoke <code class="highlighter-rouge">snap refresh</code> on the
applicable cluster components. For example, refresh all snaps on all <code class="highlighter-rouge">etcd</code>
units with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run <span class="nt">--application</span> etcd <span class="s1">'snap refresh'</span>
</code></pre></div></div>

<p>As another example, only refresh the <code class="highlighter-rouge">cdk-addons</code> snap on the
<code class="highlighter-rouge">kubernetes-master/0</code> unit with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run <span class="nt">--unit</span> kubernetes-master/0 <span class="s1">'snap refresh cdk-addons'</span>
</code></pre></div></div>

<!-- LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/snap-refresh.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
