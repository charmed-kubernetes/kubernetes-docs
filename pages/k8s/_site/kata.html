<p>Beginning with <strong>Charmed Kubernetes</strong> 1.16, the
<a href="https://katacontainers.io">Kata Containers</a> runtime can be used with
containerd to safely run insecure or untrusted pods. When enabled, Kata
provides hypervisor isolation for pods that request it, while trusted pods can
continue to run on a shared kernel via runc. The instructions below
demonstrate how to configure and use Kata containers.</p>

<h2 id="requirements">Requirements</h2>

<p>Due to their reliance on the KVM kernel module, Kata Containers can only be used
on hosts that support virtualisation. Attempting to use Kata on a host that
doesn’t support virtualisation may result in an error similar to this one:</p>

<pre><code class="language-no-highlight">Failed create pod sandbox: rpc error: code = Unknown desc = failed to start sandbox container: failed to create containerd task: Could not access KVM kernel module: No such file or directory
qemu-vanilla-system-x86_64: failed to initialize KVM: No such file or directory
</code></pre>

<p>To fulfill this requirement, using Kata Containers on a public cloud may require a
special instance type be used for the worker nodes. See the “Deploying to AWS” section
below for an example.</p>

<h2 id="deploying-kata-containers">Deploying Kata Containers</h2>

<p>Kata Containers can be deployed to any <strong>Charmed Kubernetes</strong> cluster that’s
running with <a href="/kubernetes/docs/container-runtime">containerd</a>.</p>

<h3 id="deploying-with-a-new-cluster">Deploying with a new cluster</h3>

<p>After bootstrapping a Juju controller, you can deploy Kata with <strong>Charmed Kubernetes</strong> by using
the following YAML overlay:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">kata</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:~containers/kata</span>
<span class="na">relations</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">kata:untrusted</span>
  <span class="pi">-</span> <span class="s">containerd:untrusted</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">kata</span>
  <span class="pi">-</span> <span class="s">kubernetes-master</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">kata</span>
  <span class="pi">-</span> <span class="s">kubernetes-worker</span>

</code></pre></div></div>

<p>Save this YAML and then deploy:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes <span class="nt">--overlay</span> kata.yaml
</code></pre></div></div>

<h3 id="deploying-to-an-existing-cluster">Deploying to an existing cluster</h3>

<p>Deploy the Kata charm and add the necessary relations using the following commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy cs:~containers/kata
juju add-relation kata kubernetes-master
juju add-relation kata kubernetes-worker
juju add-relation kata:untrusted containerd:untrusted
</code></pre></div></div>

<h3 id="deploying-to-aws">Deploying to AWS</h3>

<p>A convenient way to try Charmed Kubernetes with Kata Containers is to deploy it to AWS. 
A special AWS instance type is required to provide the necessary virtualisation support.
To deploy Charmed Kubernetes with Kata Containers on AWS, write the following overlay
to a file or <a href="https://raw.githubusercontent.com/charmed-kubernetes/kubernetes-docs/master/assets/kata-aws-overlay.yaml">download it here</a>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">kubernetes-worker</span><span class="pi">:</span>
    <span class="na">constraints</span><span class="pi">:</span> <span class="s">instance-type=i3.metal</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">kata</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:~containers/kata</span>
<span class="na">relations</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">kata:untrusted</span>
  <span class="pi">-</span> <span class="s">containerd:untrusted</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">kata</span>
  <span class="pi">-</span> <span class="s">kubernetes-master</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">kata</span>
  <span class="pi">-</span> <span class="s">kubernetes-worker</span>
</code></pre></div></div>

<p>Once written, deploy it with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes <span class="nt">--overlay</span> kata-aws-overlay.yaml
</code></pre></div></div>

<p>Due to the high costs of <code class="highlighter-rouge">i3.metal</code> instance types, the example above deploys only one
worker node. Feel free to edit the <code class="highlighter-rouge">num_units</code> field to suit your needs, or add more
workers later with the <code class="highlighter-rouge">juju add-unit kubernetes-worker</code> command.</p>

<h2 id="deploying-pods-to-kata">Deploying pods to Kata</h2>

<h3 id="untrusted-annotation">Untrusted annotation</h3>

<p>The simplest way to run your pods with Kata is to annotate them with
<code class="highlighter-rouge">io.kubernetes.cri.untrusted-workload: "true"</code>.  For example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-untrusted</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">io.kubernetes.cri.untrusted-workload</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
</code></pre></div></div>

<h3 id="runtimeclass">RuntimeClass</h3>

<p>If you don’t want to taint your workloads as <code class="highlighter-rouge">untrusted</code>, you can also create
the following <code class="highlighter-rouge">RuntimeClass</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">node.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RuntimeClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kata</span>
<span class="na">handler</span><span class="pi">:</span> <span class="s">kata</span>
</code></pre></div></div>

<p>After this <code class="highlighter-rouge">RuntimeClass</code> is created, workloads can be run which are pinned to
the class.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-kata</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">runtimeClassName</span><span class="pi">:</span> <span class="s">kata</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
</code></pre></div></div>

<!-- LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/kata.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>

