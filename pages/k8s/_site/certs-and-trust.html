<p>The components of <strong>Charmed Kubernetes</strong>
need to be able to communicate securely over the network. This is accomplished
using <a href="https://www.networkworld.com/article/2303073/lan-wan/lan-wan-what-is-transport-layer-security-protocol.html">TLS</a> and <a href="https://github.com/OpenVPN/easy-rsa/blob/master/doc/Intro-To-PKI.md">public-key encryption</a> with a <a href="https://en.wikipedia.org/wiki/Chain_of_trust">chain of trust</a> up
to a shared root <a href="https://en.wikipedia.org/wiki/Certificate_authority">Certificate Authority (CA)</a>. However, when the cluster
is being brought up or a new unit is being added, the chain of trust and
certificates required must be bootstrapped into the machines somehow.</p>

<h2 id="juju-relations">Juju relations</h2>

<p>All communication between <a href="https://docs.jujucharms.com/stable/en/juju-concepts#unit-and-application">Juju units</a> and the <a href="https://docs.jujucharms.com/controllers">Juju controller</a> happens
over TLS-encrypted <a href="https://en.wikipedia.org/wiki/WebSocket">websockets</a>. The certificate for the TLS connection to
the controller is added as explicitly trusted to each machine as part of the
bootstrap process using a combination of <a href="https://cloud-init.io/">cloud-init</a> and <strong>SSH</strong>.</p>

<p>With this secure channel, <strong>Juju</strong> charms can communicate with each other using
<a href="https://docs.jujucharms.com/stable/en/juju-concepts#relation">relation</a> data. The data published by one unit is sent to the controller,
which then makes it available for all other units on the same relation. The
data for each relation is scoped by ID and is only visible to units
participating in the specific relation on which it is set. However, it is
worth noting that relation data is stored on the controller machine in
<strong>MongoDB</strong>,so for truly sensitive information, proper secret storage
engines, such as <a href="https://jujucharms.com/u/openstack-charmers-next/vault/">Vault</a>, and encryption-at-rest should be used.</p>

<h2 id="managing-certificates">Managing certificates</h2>

<p>Unfortunately, the <strong>Juju</strong> controller does not provide any mechanisms for
generating or distributing additional certificates to be used by the
applications on the machines, so they must be managed by the charms via the
secure relation data channel. This is done using the <a href="https://github.com/juju-solutions/interface-tls-certificates">tls-certificates</a>
<a href="https://docs.jujucharms.com/stable/en/juju-concepts#interface">interface protocol</a> and a relation to an application providing a
Certificate Authority.  (This CA could be either a root CA, or an intermediary
CA authorised by some other root CA to issue certificates.)</p>

<p>When the relation is established, the root CA’s certificate is sent via the
relation and <a href="https://charm-helpers.readthedocs.io/en/latest/api/charmhelpers.core.host.html#charmhelpers.core.host.install_ca_cert">installed</a> as trusted. Then, certificate
requests can be issued over the relation and new certificates created by the CA
and returned over the relation.</p>

<p>Because all units with a relation to the CA have a chain of trust up to it (or
its root CA), they will automatically trust a certificate generated by the CA
without requiring anything to be communicated from the unit which holds the
certificate. On the other hand, for the certificates to be trusted externally
(such as by clients) or by applications without a relation to the CA, the CA
will have to be configured as an intermediary CA with a chain of trust up to a
globally trusted CA (such as <a href="https://en.wikipedia.org/wiki/Comodo_Group">Comodo</a> or <a href="https://en.wikipedia.org/wiki/DigiCert">DigiCert</a>).</p>

<p>The certificate information will also be included in the <strong>Kubernetes</strong> <code class="highlighter-rouge">config</code>
file that <strong>Charmed Kubernetes</strong> generates to be used by <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/">kubelet</a>, so that communications
between the local machine and Kubernetes will be secured.</p>

<h2 id="server-certificates">Server certificates</h2>

<p>Each service that will be connected to will need a <a href="https://en.wikipedia.org/wiki/Public_key_certificate#TLS/SSL_server_certificate">server certificate</a>
identifying and validating it to any clients that wish to connect.</p>

<p>The primary address at which the service can be reached will be its <a href="https://knowledge.digicert.com/solution/SO7239.html">common
name</a>; ideally, this will be a fully-qualified domain name (FQDN) which
will not change, but for internal service communication, it is often just the
<a href="https://docs.jujucharms.com/stable/en/developer-network-primitives">ingress address</a> for the unit. Any additional names or
addresses by which the service can be reached will be its <a href="https://en.wikipedia.org/wiki/Subject_Alternative_Name">subject alternative
names (SANs)</a>.</p>

<p><strong>Charmed Kubernetes</strong> will manage the server certificates automatically, including
generating the certificate with the proper CN and SANs. However, the
<a href="https://jujucharms.com/u/containers/kubernetes-master/">kubernetes-master</a> charm also supports an <a href="https://jujucharms.com/u/containers/kubernetes-master/#charm-config-extra_sans"><code class="highlighter-rouge">extra_sans</code></a> option which
can be used to provide additional names to be added to the SANs list.</p>

<h2 id="client-certificates">Client certificates</h2>

<p>In order to provide for two-way security, some services require that clients
identify themselves via a <a href="https://en.wikipedia.org/wiki/Public_key_certificate#TLS/SSL_client_certificate">client certificate</a>. These are more or less the
same as server certificates, but are presented by a client to the service
they are connecting to so that the service can validate that client’s identity.
Client certificates can <em>only</em> be used to identify a client and will be
rejected by clients if presented by a service they are connecting to.</p>

<h1 id="certificate-authorities-for-charmed-kubernetes">Certificate Authorities for Charmed Kubernetes</h1>

<p><strong>Charmed Kubernetes</strong> can use a CA provided by any charm which <a href="https://jujucharms.com/q/?provides=tls-certificates">provides a tls-certificates
endpoint</a>. The two current recommendations are
<strong>EasyRSA</strong> and <strong>Vault</strong>.</p>

<h2 id="easyrsa">EasyRSA</h2>

<p>By default, the <strong>Charmed Kubernetes</strong> bundle includes the <a href="https://jujucharms.com/u/containers/easyrsa/">EasyRSA charm</a>. This
is a relatively simple charm which uses <a href="https://github.com/OpenVPN/easy-rsa">OpenVPN’s easy-rsa</a> to
provide a CA and sign certificates. This is lightweight and works out
of the box without any additional configuration, but it cannot act as an
intermediary CA and does not support <a href="https://en.wikipedia.org/wiki/High_availability">HA</a>.</p>

<h2 id="vault">Vault</h2>

<p>For production systems, it is recommended to replace EasyRSA with the <a href="https://jujucharms.com/u/openstack-charmers-next/vault/">Vault
charm</a>. This uses <a href="https://www.vaultproject.io">HashiCorp’s Vault</a> to provide either a
root or intermediate CA. It can also be deployed HA, as well as provide a secure
secrets store which can be used to enable encryption-at-rest for <strong>Charmed Kubernetes</strong>. However,
it requires a database to store its data, and (depending on configuration)
some manual steps will be required after deployment as well as after any reboot
to unseal Vault so that the secrets, such as certificates and signing keys, can
be accessed.</p>

<p>See the <a href="/kubernetes/docs/using-vault">operations documentation</a> for details on how to deploy Vault as a CA.</p>

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/certs-and-trust.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
