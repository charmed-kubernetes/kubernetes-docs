<h2 id="how-to-add-ceph-storage">How to add <strong>Ceph</strong> storage</h2>

<p>Many things you will want to use your Kubernetes cluster for will require some
form of available storage. Storage is quite a large topic – this guide will
focus on just adding some quick storage using <strong>Ceph</strong>, so you can get up and
running quickly.</p>

<h3 id="what-youll-need">What you’ll need</h3>

<ul>
  <li>A <strong>Charmed Kubernetes</strong> environment set up and running. See the [quickstart][quickstart] if you haven’t .</li>
  <li>An existing <strong>Ceph</strong> cluster or the ability to create one.</li>
</ul>

<h3 id="deploying-ceph">Deploying Ceph</h3>

<p>Setting up a Ceph cluster is easy with Juju. For this example we will deploy
three ceph monitor nodes:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> juju deploy <span class="nt">-n</span> 3 ceph-mon
</code></pre></div></div>

<p>…and then we’ll add three storage nodes. For the storage nodes, we will also
specify some actual storage for these nodes to use by using <code class="highlighter-rouge">-- storage</code>. In
this case the Juju charm uses labels for different types of storage:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> juju deploy <span class="nt">-n</span> 3 ceph-osd <span class="nt">--storage</span> osd-devices<span class="o">=</span>32G,2 <span class="nt">--storage</span> osd-journals<span class="o">=</span>8G,1
</code></pre></div></div>

<p>This will deploy a storage node, and attach two 32GB devices for storage and
8GB for journalling. As we have asked for 3 machines, this means a total of
192GB of storage and 24GB of journal space. The storage comes from whatever the
default storage class is for the cloud (e.g., on AWS this will be EBS volumes).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju add-relation ceph-osd ceph-mon
</code></pre></div></div>

<div class="p-notification--information">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
For more on how Juju makes use of storage, please see the relevant
<a href="https://docs.jujucharms.com/stable/en/charms-storage"> Juju documentation</a>
  </p>
</div>

<h3 id="relating-to-charmed-kubernetes">Relating to Charmed Kubernetes</h3>

<p>Making <strong>Charmed Kubernetes</strong> aware of your <strong>Ceph</strong> cluster just requires a <strong>Juju</strong> relation.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju add-relation ceph-mon kubernetes-master
</code></pre></div></div>

<p>Note that the <strong>Ceph</strong> CSI containers require privileged access:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master allow-privileged<span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<p>And finally, you need the pools that are defined in the storage class:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action ceph-mon/0 create-pool <span class="nv">name</span><span class="o">=</span>xfs-pool <span class="nt">--wait</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">unit-ceph-mon-0</span><span class="pi">:</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">c12f0688-f31b-4956-8314-abacd2d6516f</span>
  <span class="na">status</span><span class="pi">:</span> <span class="s">completed</span>
  <span class="na">timing</span><span class="pi">:</span>
    <span class="na">completed</span><span class="pi">:</span> <span class="s">2018-08-20 20:49:34 +0000 UTC</span>
    <span class="na">enqueued</span><span class="pi">:</span> <span class="s">2018-08-20 20:49:31 +0000 UTC</span>
    <span class="na">started</span><span class="pi">:</span> <span class="s">2018-08-20 20:49:31 +0000 UTC</span>
  <span class="na">unit</span><span class="pi">:</span> <span class="s">ceph-mon/0</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action ceph-mon/0 create-pool <span class="nv">name</span><span class="o">=</span>ext4-pool <span class="nt">--wait</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">unit-ceph-mon-0</span><span class="pi">:</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">4e82d93d-546f-441c-89e1-d36152c082f2</span>
  <span class="na">status</span><span class="pi">:</span> <span class="s">completed</span>
  <span class="na">timing</span><span class="pi">:</span>
    <span class="na">completed</span><span class="pi">:</span> <span class="s">2018-08-20 20:49:45 +0000 UTC</span>
    <span class="na">enqueued</span><span class="pi">:</span> <span class="s">2018-08-20 20:49:41 +0000 UTC</span>
    <span class="na">started</span><span class="pi">:</span> <span class="s">2018-08-20 20:49:43 +0000 UTC</span>
  <span class="na">unit</span><span class="pi">:</span> <span class="s">ceph-mon/0</span>
</code></pre></div></div>

<h3 id="verifying-things-are-working">Verifying things are working</h3>

<p>Now you can look at your <strong>Charmed Kubernetes</strong> cluster to verify things are
working. Running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get sc,po
</code></pre></div></div>

<p>… should return output similar to:</p>

<pre><code class="language-no-highlight">NAME                                             PROVISIONER     AGE
storageclass.storage.k8s.io/ceph-ext4            csi-rbdplugin    7m
storageclass.storage.k8s.io/ceph-xfs (default)   csi-rbdplugin    7m

NAME                                                   READY     STATUS    RESTARTS   AGE
pod/csi-rbdplugin-attacher-0                           1/1       Running   0          7m
pod/csi-rbdplugin-cnh9k                                2/2       Running   0          7m
pod/csi-rbdplugin-lr66m                                2/2       Running   0          7m
pod/csi-rbdplugin-mnn94                                2/2       Running   0          7m
pod/csi-rbdplugin-provisioner-0                        1/1       Running   0          7m
</code></pre>

<p>If you have installed <strong>Helm</strong>, you can then add a chart to verify the persistent volume is automatically created for you.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install </span>stable/phpbb
kubectl get pvc
</code></pre></div></div>

<p>Which should return something similar to:</p>

<pre><code class="language-ǹo-highlight">NAME                            STATUS    VOLUME                 CAPACITY   ACCESS MODES   STORAGECLASS   AGE
calling-wombat-phpbb-apache     Bound     pvc-b1d04079a4bd11e8   1Gi        RWO            ceph-xfs       34s
calling-wombat-phpbb-phpbb      Bound     pvc-b1d1131da4bd11e8   8Gi        RWO            ceph-xfs       34s
data-calling-wombat-mariadb-0   Bound     pvc-b1df7ac9a4bd11e8   8Gi        RWO            ceph-xfs       34s
</code></pre>

<h3 id="conclusion">Conclusion</h3>

<p>Now you have a <strong>Ceph</strong> cluster talking to your <strong>Kubernetes</strong> cluster. From
here you can install any of the things that require storage out of the box.</p>

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/ceph.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
