<p><strong>Charmed Kubernetes</strong> will run seamlessly
on OpenStack. With the addition of the <code class="highlighter-rouge">openstack-integrator</code>, your cluster
will also be able to directly use OpenStack native features.</p>

<h2 id="openstack-integrator">OpenStack integrator</h2>

<p>The <code class="highlighter-rouge">openstack-integrator</code> charm simplifies working with <strong>Charmed Kubernetes</strong> on OpenStack. Using the
credentials provided to Juju, it acts as a proxy between Charmed Kubernetes and the underlying cloud,
granting permissions to dynamically create, for example, Cinder volumes.</p>

<h3 id="installing">Installing</h3>

<p>When installing <strong>Charmed Kubernetes</strong> <a href="/kubernetes/docs/install-manual">using the Juju bundle</a>, you can add the openstack-integrator at
the same time by using the following overlay file
(<a href="https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/openstack-overlay.yaml">download it here</a>):</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">description</span><span class="pi">:</span> <span class="s">Charmed Kubernetes overlay to add native OpenStack support.</span>
<span class="na">applications</span><span class="pi">:</span>
  <span class="na">openstack-integrator</span><span class="pi">:</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">gui-x</span><span class="pi">:</span> <span class="s2">"</span><span class="s">600"</span>
      <span class="na">gui-y</span><span class="pi">:</span> <span class="s2">"</span><span class="s">300"</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:~containers/openstack-integrator</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">trust</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">relations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">openstack-integrator'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">kubernetes-master:openstack'</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">openstack-integrator'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">kubernetes-worker:openstack'</span><span class="pi">]</span>
</code></pre></div></div>

<p>If desired, the openstack-integrator can also replace kubeapi-load-balancer and create a native OpenStack
load balancer for the Kubernetes API server, which both reduces the number of machines required and is
HA. To enable this, use this overlay instead (<a href="https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/openstack-lb-overlay.yaml">download it here</a>):</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">kubeapi-load-balancer</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">openstack-integrator</span><span class="pi">:</span>
    <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">gui-x</span><span class="pi">:</span> <span class="s2">"</span><span class="s">600"</span>
      <span class="na">gui-y</span><span class="pi">:</span> <span class="s2">"</span><span class="s">300"</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:~containers/openstack-integrator</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">trust</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">relations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">openstack-integrator'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">kubernetes-master:loadbalancer'</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">openstack-integrator'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">kubernetes-master:openstack'</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">openstack-integrator'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">kubernetes-worker:openstack'</span><span class="pi">]</span>
</code></pre></div></div>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
If you create load balancers and subsequently tear down the cluster, check with
the OpenStack administration tools to make sure all the associated resources
have also been released.
  </p>
</div>

<p>To use the overlay with the <strong>Charmed Kubernetes</strong> bundle, specify it during deploy like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes <span class="nt">--overlay</span> ~/path/openstack-overlay.yaml
</code></pre></div></div>

<p>Then run the command to share credentials with this charm:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju trust openstack-integrator
</code></pre></div></div>

<p>… and remember to fetch the configuration file!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju scp kubernetes-master/0:config ~/.kube/config
</code></pre></div></div>

<p>For more configuration options and details of the permissions which the integrator uses,
please see the <a href="https://jujucharms.com/u/containers/openstack-integrator/">charm readme</a>.</p>

<h3 id="using-cinder-volumes">Using Cinder volumes</h3>

<p>Many  pods you may wish to deploy will require storage. Although you can use any type
of storage supported by Kubernetes (see the <a href="/kubernetes/docs/storage">storage documentation</a>), you
also have the option to use Cinder storage volumes, if supported by your OpenStack.</p>

<p>A <code class="highlighter-rouge">cinder</code> storage class will be automatically created for you when the integrator is
used.  This storage class can then be used when creating a Persistent Volume Claim:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOY</span><span class="sh">
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: testclaim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Mi
  storageClassName: cinder
</span><span class="no">EOY
</span></code></pre></div></div>

<p>This should finish with a confirmation. You can check the current PVCs with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pvc
</code></pre></div></div>

<p>…which should return something similar to:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
testclaim   Bound    pvc-54a94dfa-3128-11e9-9c54-028fdae42a8c   1Gi        RWO            cinder         9s
</code></pre></div></div>

<p>This PVC can then be used by pods operating in the cluster. As an example, the following
deploys a <code class="highlighter-rouge">busybox</code> pod:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOY</span><span class="sh">
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
    - image: busybox
      command:
        - sleep
        - "3600"
      imagePullPolicy: IfNotPresent
      name: busybox
      volumeMounts:
        - mountPath: "/pv"
          name: testvolume
  restartPolicy: Always
  volumes:
    - name: testvolume
      persistentVolumeClaim:
        claimName: testclaim
</span><span class="no">EOY
</span></code></pre></div></div>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
If you create Cinder volumes and subsequently tear down the cluster, check with
the OpenStack administration tools to make sure all the associated resources
have also been released.
  </p>
</div>

<h3 id="using-lbaas-load-balancers">Using LBaaS load balancers</h3>

<p>With the openstack-integrator charm in place, actions which invoke a
loadbalancer in Kubernetes will automatically request a load balancer from
OpenStack using Octavia, if available, or Neutron. This can be demonstrated
with a simple application. Here we will create a simple application running in
five pods:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run hello-world <span class="nt">--replicas</span><span class="o">=</span>5 <span class="nt">--labels</span><span class="o">=</span><span class="s2">"run=load-balancer-example"</span> <span class="nt">--image</span><span class="o">=</span>gcr.io/google-samples/node-hello:1.0  <span class="nt">--port</span><span class="o">=</span>8080
</code></pre></div></div>

<p>You can verify that the application and replicas have been created with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl get deployments hello-world
</code></pre></div></div>

<p>Which should return output similar to:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> NAME              READY   UP-TO-DATE   AVAILABLE   AGE
 hello-world      5/5               5                            5             2m38s
</code></pre></div></div>

<p>To create a LoadBalancer, the application should now be exposed as a service:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl expose deployment hello-world <span class="nt">--type</span><span class="o">=</span>LoadBalancer <span class="nt">--name</span><span class="o">=</span>hello
</code></pre></div></div>

<p>To check that the service is running correctly:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get service hello
</code></pre></div></div>

<p>…which should return output similar to:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">NAME    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span>
<span class="s">hello   LoadBalancer   10.152.183.136   202.49.242.3  8080:32662/TCP   2m</span>
</code></pre></div></div>

<p>You can see that the External IP is now in front of the five endpoints of the
example deployment. You can test the ingress address:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl  http://202.49.242.3:8080
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello Kubernetes!
</code></pre></div></div>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
If you create load balancers and subsequently tear down the cluster, check with
the OpenStack administration tools to make sure all the associated resources
have also been released.
  </p>
</div>

<h3 id="upgrading-the-integrator-charm">Upgrading the integrator charm</h3>

<p>The openstack-integrator is not specifically tied to the version of Charmed Kubernetes installed and may
generally be upgraded at any time with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm openstack-integrator
</code></pre></div></div>

<h3 id="troubleshooting">Troubleshooting</h3>

<p>If you have any specific problems with the openstack-integrator, you can report bugs on
<a href="https://bugs.launchpad.net/charmed-kubernetes">Launchpad</a>.</p>

<p>For logs of what the charm itself believes the world to look like, you can use Juju to replay
the log history for that specific unit:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju debug-log <span class="nt">--replay</span> <span class="nt">--include</span> openstack-integrator/0
</code></pre></div></div>

<!-- LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/openstack-integration.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
