<p><strong>HAcluster</strong> is a <strong>Juju</strong> subordinate charm that encapsulates <strong>corosync</strong>
and *pacemaker** for floating virtual IP or DNS addresses and is similar to
<a href="/kubernetes/docs/keepalived">keepalived</a>. It differentiates itself in that it allows servers
to span subnets via the DNS option, which communicates directly with
<a href="https://maas.io">MAAS</a>. It also has the ability to shoot the other node in the
head(STONITH) via <strong>MAAS</strong> to prevent issues in a split-brain scenario.</p>

<p><strong>Charmed Kubernetes</strong> supports <strong>HAcluster</strong> via a relation and the configuration options
<code class="highlighter-rouge">ha-cluster-vip</code> and <code class="highlighter-rouge">ha-cluster-dns</code>. Relations to the kubernetes-master and
kubeapi-load-balancer charms are supported. These options are mutually exclusive.</p>

<h2 id="deploying">Deploying</h2>

<p>In order to use HAcluster, the first decision is if a load balancer is desired.
This depends on the size of the cluster and the expected control plane load.
Note that HAcluster requires a minimum of 3 units for a quorum, so you will
need 3 kubeapi-load-balancer or 3 kubernetes-master units to use HAcluster.</p>

<h3 id="with-load-balancer">With Load Balancer</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes
juju add-unit <span class="nt">-n</span> 2 kubeapi-load-balancer
juju deploy hacluster
juju config kubeapi-load-balancer ha-cluster-vip<span class="o">=</span><span class="s2">"192.168.0.1 192.168.0.2"</span>
juju relate kubeapi-load-balancer hacluster
</code></pre></div></div>

<h3 id="without-load-balancer">Without Load Balancer</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy kubernetes-core
juju add-unit <span class="nt">-n</span> 2 kubernetes-master
juju deploy hacluster
juju config kubernetes-master ha-cluster-vip<span class="o">=</span><span class="s2">"192.168.0.1 192.168.0.2"</span>
juju relate kubernetes-master hacluster
</code></pre></div></div>

<h2 id="validation">Validation</h2>

<p>Once things settle, the virtual IP addresses should be pingable. A new
kubeconfig file will be created containing the virtual IP addresses. You will
need to replace your kubeconfig with the new one:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju scp kubernetes-master/0:config ~/.kube/config
</code></pre></div></div>

<!-- LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/hacluster.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
