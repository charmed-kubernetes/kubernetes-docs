<p><strong>Kubernetes</strong> has the concept of <a href="https://kubernetes.io/docs/tasks/inject-data-application/distribute-credentials-secure/">secrets</a> for managing sensitive information
needed by a cluster, such as usernames and passwords, encryption keys, etc.
Secrets can be managed independently of the pod(s) which need them and can be
made available to the pods that require them as needed.</p>

<p>By default, the secret data is stored in plaintext in <strong>etcd</strong>. <strong>Kubernetes</strong>
does support <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">encryption at rest</a> for the data in <strong>etcd</strong>, but the key for
that encryption is stored in plaintext in the config file on the master nodes.
To protect this key at rest, <strong>Charmed Kubernetes</strong> can use
<a href="https://www.vaultproject.io/">HashiCorpâ€™s Vault</a> and <a href="https://github.com/openstack-charmers/vaultlocker">VaultLocker</a> to securely generate, share, and
configure the encryption key used by <strong>Kubernetes</strong>.</p>

<h2 id="using-encryption-at-rest-with-charmed-kubernetes">Using Encryption-at-Rest with Charmed Kubernetes</h2>

<p>To enable encryption-at-rest for <strong>Charmed Kubernetes</strong>, simply deploy the <a href="https://jujucharms.com/u/openstack-charmers-next/vault/">Vault charm</a> (as
well as a database backend for it), and relate it to <code class="highlighter-rouge">kubernetes-master</code> via
the <code class="highlighter-rouge">vault-kv</code> relation endpoint.  The easiest way to do this is to deploy <strong>Charmed Kubernetes</strong>
with the following overlay:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">vault</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:~openstack-charmers-next/vault</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">percona-cluster</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:percona-cluster</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
<span class="na">relations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">vault'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">percona-cluster'</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">vault:secrets'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">kubernetes-master:vault-kv'</span><span class="pi">]</span>
</code></pre></div></div>

<p>To deploy <strong>Charmed Kubernetes</strong> with this overlay - <a href="https://raw.githubusercontent.com/juju-solutions/kubernetes-docs/master/assets/cdk-vault-overlay.yaml">download it</a>), save it as, e.g.,
<code class="highlighter-rouge">cdk-vault-overlay.yaml</code>, and deploy with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes --overlay cdk-vault-overlay.yaml
</code></pre></div></div>

<p>Once <strong>Vault</strong> comes up (and any time it is rebooted), you will need to <a href="https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-vault.html#initialize-and-unseal-vault">unseal</a>
it.</p>

<p>Charmed Kubernetes will then automatically enable encryption for the secrets data stored in
<strong>etcd</strong>.</p>

<h2 id="known-issues">Known Issues</h2>

<p>This does not work on <strong>LXD</strong> at this time, due to security limitations
preventing charms from acquiring and managing the block devices and file
systems needed to implement this.  In the future, support for KMS, or
encryption-as-a-service, will remove this restriction.  In the meantime,
<strong>LXD</strong> deployments can make use of encryption at the level of the <strong>LXD</strong>
storage pool, or even full-disk-encryption on the host machine.</p>

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/encryption-at-rest.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
