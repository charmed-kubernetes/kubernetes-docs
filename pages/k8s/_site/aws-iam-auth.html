<h2 id="aws-iam">AWS IAM</h2>

<p><a href="https://aws.amazon.com/iam/">AWS IAM</a> credentials can be used for
authentication and authorisation on your <strong>Charmed Kubernetes</strong> cluster without
regard to where it is hosted. The only requirement is that both the client
machine running <code class="highlighter-rouge">kubectl</code> and the nodes running the webhook pod(s) are able to
reach AWS in order to get and validate tokens.</p>

<h3 id="installing">Installing</h3>

<p>The subordinate charm <a href="https://jaas.ai/u/containers/aws-iam-authenticator">aws-iam-authenticator</a>
and some relations are all that are required. These can be added with the
following overlay(<a href="https://raw.githubusercontent.com/charmed-kubernetes/kubernetes-docs/master/assets/aws-iam-overlay.yaml">download it here</a>):</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">aws-iam</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:~containers/aws-iam</span>
<span class="na">relations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">aws-iam'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">kubernetes-master'</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">aws-iam'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">vault'</span><span class="pi">]</span>
</code></pre></div></div>

<p>or if using easyrsa:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">aws-iam</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:~containers/aws-iam</span>
<span class="na">relations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">aws-iam'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">kubernetes-master'</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s1">'</span><span class="s">aws-iam'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">easyrsa'</span><span class="pi">]</span>
</code></pre></div></div>

<p>To use this overlay with the <strong>Charmed Kubernetes</strong> bundle, it is specified
during deploy like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes  <span class="nt">--overlay</span> ~/path/aws-iam-overlay.yaml
</code></pre></div></div>

<h3 id="user-configuration">User Configuration</h3>

<p>The <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator">aws-iam-authenticator</a> is configured via
<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resource Definition or CRD</a>s. These resource definitions
map an AWS IAM role or user to a <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Kubernetes RBAC</a> user
or group. This means that authentication happens via AWS IAM credentials,
but authorisation depends on standard Kubernetes RBAC rules. The CRD for
this mapping is called an IAMIdentityMapping and looks something like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">iamauthenticator.k8s.aws/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IAMIdentityMapping</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes-admin</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="c1"># Arn of the User or Role to be allowed to authenticate</span>
  <span class="na">arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::xxxxx:role/k8s-view-role</span>
  <span class="c1"># Username that Kubernetes will see the user as, this is useful for setting</span>
  <span class="c1"># up allowed specific permissions for different users</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">john</span>
  <span class="c1"># Groups to be attached to your users/roles. For example `system:masters` to</span>
  <span class="c1"># create cluster admin, or `view` for view only,</span>
  <span class="na">groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">view</span>
</code></pre></div></div>

<h3 id="using-aws-iam-with-kubectl">Using AWS-IAM with kubectl</h3>

<h4 id="download-aws-iam-authenticator">Download aws-iam-authenticator</h4>

<p>The <code class="highlighter-rouge">aws-iam-authenticator</code> binary needs to be installed on the machine that is
running kubectl. This is executed by kubectl in order to log in and get a token,
which is then passed to the Kubernetes API server. You can find the binary
on the <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator/releases">aws-iam-authenticator releases page</a>.</p>

<h4 id="setting-up-aws-role">Setting up AWS Role</h4>

<p>The aws-iam-authenticator is able to use any ARN for authentication. The easiest
way to get started is to use an empty role as described in the
<a href="https://github.com/kubernetes-sigs/aws-iam-authenticator#1-create-an-iam-role">aws-iam documentation</a>.</p>
<ul>
  <li>Log into AWS console and navigate to <a href="https://console.aws.amazon.com/iam/home">the IAM page</a>.</li>
  <li>Click “create new role”.</li>
  <li>Choose the “Role for cross-account access” / “Provide access between AWS accounts you own” option.</li>
  <li>Paste in your AWS account ID number (available in the top right in the console).</li>
  <li>Your role does not need any additional policies attached.</li>
</ul>

<h4 id="updating-kubectl-config">Updating kubectl config</h4>

<p>In order to use the <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator">aws-iam-authenticator</a> with
kubectl, an updated config file is needed. The config file written to the
kubernetes-master unit will have a user named <code class="highlighter-rouge">aws-iam-user</code> that uses the
<code class="highlighter-rouge">aws-iam-authenticator</code> client binary and a context named aws-iam-authenticator.
First, copy the config:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju scp kubernetes-master/0:config ~/.kube/config
</code></pre></div></div>

<p>The config file will need to be edited in order to add the desired
Amazon Resource Name(ARN) for authentication. Information about this can
be found on the
<a href="https://github.com/kubernetes-sigs/aws-iam-authenticator#4-set-up-kubectl-to-use-authentication-tokens-provided-by-aws-iam-authenticator-for-kubernetes">aws-iam-authenticator documentation</a>.
It is necessary to replace «insert_arn_here» with the ARN of the
aws user or role desired. It may also be necessary to adjust the
command to fully-qualify the path to <code class="highlighter-rouge">aws-iam-authenticator</code> if
it is not located in your path.</p>

<p>Before switching context to the aws-iam context, be sure to deploy the CRD
above to give your user access to the cluster.</p>

<p>The context that uses aws-iam-authenticator can be selected with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config use-context aws-iam-authenticator
</code></pre></div></div>

<p>Note that the <code class="highlighter-rouge">aws-iam-authenticator</code> binary behaves like the
<code class="highlighter-rouge">aws</code> command line interface in that it will read environment
variables like AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY. See
<a href="https://github.com/kubernetes-sigs/aws-iam-authenticator#specifying-credentials--using-aws-profiles">aws-iam-authenticator credentials docs</a> for more
information.</p>

<h3 id="a-note-about-authorisation">A note about authorisation</h3>

<p>The AWS-IAM charm can be used for authentication only or can be used in an
RBAC-enabled cluster to authorise users as well. If the charm is related to
a Charmed Kubernetes cluster without RBAC enabled, any valid AWS IAM
credential that can assume a role specified in the IAMIdentityMapping
CRD will be able to run commands against the cluster. If RBAC is enabled,
the user will have the permissions of the user defined in the
IAMIdentityMapping CRD.</p>

<h3 id="enabling-rbac">Enabling RBAC</h3>

<p>In order to get authorisation with AWS-IAM, you will need to use RBAC.
Refer to the Charmed Kubernetes <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">RBAC documentation</a> for
complete options, but at a minimum you will need to enable RBAC with
<code class="highlighter-rouge">juju config kubernetes-master authorization-mode="RBAC,Node"</code>. At
this point, valid AWS credentials will fail unless connected to a default
account.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get po <span class="nt">-A</span>
</code></pre></div></div>
<p>… will result in an error:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error from server (Forbidden): pods is forbidden: User "knobby" cannot list resource "pods" in API group "" at the cluster scope
</code></pre></div></div>

<p>The username is pulled from the matching CRD. In this case, the following CRD was used:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">iamauthenticator.k8s.aws/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IAMIdentityMapping</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes-admin</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="c1"># Arn of the User or Role to be allowed to authenticate</span>
  <span class="na">arn</span><span class="pi">:</span> <span class="s">arn:aws:iam::xxxxxxxxxx:role/k8s-view-role</span>
  <span class="c1"># Username that Kubernetes will see the user as, this is useful for setting</span>
  <span class="c1"># up allowed specific permissions for different users</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">knobby</span>
  <span class="c1"># Groups to be attached to your users/roles. For example `system:masters` to</span>
  <span class="c1"># create cluster admin, or `system:nodes`, `system:bootstrappers` for nodes to</span>
  <span class="c1"># access the API server.</span>
  <span class="na">groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">view</span>
</code></pre></div></div>
<p>Logging in with the k8s-view-role matched against the RBAC user ‘knobby’, but this user has
no permissions so the command failed. Create an RBAC Role and RoleBinding to grant permissions:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod-reader</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="c1"># This role binding allows "knobby" to read pods in the "default" namespace.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">read-pods</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">User</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">knobby</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod-reader</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>Now the command will succeed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get po
</code></pre></div></div>

<pre><code class="language-no-highlight">No resources found.
</code></pre>

<p>Note that the permissions in this example are limited to the ‘default’ namespace. For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get po <span class="nt">--all-namespaces</span>
</code></pre></div></div>
<p>…will result in an error:</p>

<pre><code class="language-no-highlight">Error from server (Forbidden): pods is forbidden: User "knobby" cannot list resource "pods" in API group "" at the cluster scope
</code></pre>

<h3 id="upgrading-the-aws-iam-charm">Upgrading the AWS-IAM charm</h3>

<p>The AWS IAM charm is not specifically tied to the version of
Charmed Kubernetes installed and may generally be upgraded at any
time with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm aws-iam
</code></pre></div></div>

<h3 id="troubleshooting">Troubleshooting</h3>

<p>If you have any specific problems with aws-iam, you
can report bugs on <a href="https://bugs.launchpad.net/aws-iam">Launchpad</a>.</p>

<p>Since aws-iam charm makes use of IAM accounts in AWS to
perform actions, activity logs can be obtained from
<a href="https://console.aws.amazon.com/cloudtrail/">Amazon’s CloudTrail</a>.</p>

<p>The flow of operations that occur when using kubectl with aws-iam is as follows:</p>
<ol>
  <li>kubectl execs <code class="highlighter-rouge">aws-iam-authenticator</code> to get a token.</li>
  <li><code class="highlighter-rouge">aws-iam-authenticator</code> contacts AWS from the user’s machine
to get the token.</li>
  <li>kubectl passes token to the Kubernetes API server.</li>
  <li>The API server passes the token to the webhook pod for verification.</li>
  <li>The webhook pod contacts AWS to verify the token.</li>
  <li>The webhook pod returns RBAC user information to the API server.</li>
  <li>The API server uses RBAC rules to authorise the user.</li>
</ol>

<p>One can troubleshoot these steps to figure out where things are going wrong.</p>
<ul>
  <li>Run <code class="highlighter-rouge">aws-iam-authenticator token -i &lt;cluster id&gt; -r &lt;aws arn&gt;</code> to see if a
token is returned. Note that <code class="highlighter-rouge">aws-iam-authenticator</code> will cache credentials
between calls.</li>
  <li>Check verbose output of <code class="highlighter-rouge">kubectl</code> command by adding <code class="highlighter-rouge">--v=9</code> such as
<code class="highlighter-rouge">kubectl get po --v=9</code></li>
  <li>Check the logs of the <code class="highlighter-rouge">aws-iam-authenticator</code> deployment with
<code class="highlighter-rouge">juju run --unit kubernetes-master/0 -- /snap/bin/kubectl -n kube-system logs deploy/aws-iam-authenticator</code></li>
  <li>Check the logs of the API server with <code class="highlighter-rouge">juju run --unit kubernetes-master/0 -- journalctl -u snap.kube-apiserver.daemon.service</code></li>
</ul>

<!-- LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/aws-iam-auth.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
