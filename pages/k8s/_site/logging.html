<div class="p-notification--information">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
This documentation assumes you are using version 2.4.0 or later of
<strong>Juju</strong>. If you are using an earlier version you should check
the <a href="https://docs.jujucharms.com/stable/en/troubleshooting-logs">
relevant <emphasis>Juju</emphasis> documentation</a> as some of the associated
commands have changed.
  </p>
</div>

<p>Broadly, there are two types of logs you may be interested in. On cluster or
node level; for the applications you are running inside your cluster, and at an
infrastructure level, the applications which are responsible for running the
cluster itself. As <strong>Charmed Kubernetes</strong> is pure Kubernetes, you can use
any of the tools and techniques to examine cluster logs as <a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/">described in the
Kubernetes documentation</a>. Additionally, you can deploy Graylog
alongside your cluster - please see the <a href="#graylog">section on Graylog below</a>.</p>

<p>For the infrastructure, your <strong>Charmed Kubernetes</strong> deployment has centralised
logging set up by default. Each unit in your cluster automatically sends
logging information to the controller based on the current logging level. You
can use the <strong>Juju</strong> command line to easily inspect these logs and to change
the logging level, as explained below.</p>

<h2 id="viewing-logs">Viewing logs</h2>

<p>To view the logs from the current controller and model, simply run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju debug-log
</code></pre></div></div>

<p>The default behaviour is to show the last 10 entries and to tail the log (so
you will need to terminate the command with <code class="highlighter-rouge">Ctrl-C</code>).</p>

<p>The output is in the form:</p>

<p><code class="highlighter-rouge">&lt;entity&gt; &lt;timestamp&gt; &lt;log-level&gt; &lt;module&gt;[:&lt;line-no&gt;] &lt;message&gt;</code></p>

<p>For example, a typical line of output might read:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unit-kubernetes-master-0: 18:04:11 INFO juju.cmd running jujud [2.4.2 gc go1.10]
</code></pre></div></div>

<p>The entity is the unit, machine or application the message originates from (in
this case <em>kubernetes-master/0</em>). It can be very useful to filter the output
based on the entity or log level, and the <code class="highlighter-rouge">debug-log</code> command has many options.</p>

<p>For a full description, run the command <code class="highlighter-rouge">juju help debug-log</code> or see the
<a href="https://docs.jujucharms.com/stable/en/troubleshooting-logs"><strong>Juju</strong> documentation</a>. Some useful examples are outlined below.</p>

<h3 id="useful-examples">Useful examples</h3>

<p>View the last 100 entries and tail the log:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju debug-log <span class="nt">-n</span> 100
</code></pre></div></div>

<p>Show the last 20 entries and exit:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju debug-log <span class="nt">-n</span> 20 <span class="nt">--no-tail</span>
</code></pre></div></div>

<p>Replay the log from the very beginning, but filter to logs from kubernetes-worker/0:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju debug-log <span class="nt">--replay</span> <span class="nt">--include</span><span class="o">=</span>kubernetes-worker/0
</code></pre></div></div>

<h2 id="viewing-logs-on-a-machine">Viewing logs on a machine</h2>

<p>If it becomes necessary for any reason, it is also possible to view logs
directly on the running machine. A user with SSH access can connect to the
relevant machine and find the logs for all the units running on that machine in
the directory <code class="highlighter-rouge">/var/logs/juju</code>. The <code class="highlighter-rouge">juju ssh</code> command can be used for this,
and you can connect to the relevant machine using a unit identifier. So for
example, to look at the logs on the machine running the first unit of
<code class="highlighter-rouge">kubernetes-worker</code> you can run the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju ssh kubernetes-worker/0
<span class="nb">ls</span> /var/logs/juju/
</code></pre></div></div>

<p>Which should show something similar to:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>machine-1.log  machine-lock.log  unit-flannel-1.log  unit-kubernetes-worker-0.log
</code></pre></div></div>

<p>Note that the logs from other units (in this case ‘flannel’) running on this
machine can also be found here.</p>

<h2 id="logging-level">Logging level</h2>

<p>You can check the current logging level by running the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju model-config logging-config
</code></pre></div></div>

<p>This will result in output similar to:</p>

<pre><code class="language-no-highlight">&lt;root&gt;=WARNING;unit=DEBUG
</code></pre>

<p>…which is the default for any Juju model. This indicates that the <em>machine</em>
log level is set to ‘WARNING’, and the <em>unit</em> logging level is set to ‘DEBUG’.
As all the software components of your kubernetes cluster run in units, these
logs are likely to be useful for diagnosing issues with software.</p>

<p>The logging levels, from most verbose to least verbose, are as follows:</p>

<ul>
  <li>TRACE</li>
  <li>DEBUG</li>
  <li>INFO</li>
  <li>WARNING</li>
  <li>ERROR</li>
</ul>

<p>The logging level can be set like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> juju model-config logging-config<span class="o">=</span><span class="s2">"&lt;root&gt;=WARNING;unit=TRACE"</span>
</code></pre></div></div>

<p>…which in this case sets the logging level for all units to TRACE</p>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Caution!</span>
    It isn’t a good idea to leave the logging level at ‘TRACE’ for any longer than
    you actually need to. Verbose logging not only consumes network bandwidth but
    also fills up the database on the controller.
  </p>
</div>

<h2 id="additional-information">Additional information</h2>

<p>As previously mentioned, you can see more detailed information on accessing the
logs from your cluster in the <a href="https://docs.jujucharms.com/stable/en/troubleshooting-logs"><strong>Juju</strong> documentation</a>, including
the following:</p>

<ul>
  <li>Altering the agent logging setup</li>
  <li>Setting up remote logging</li>
  <li>More advanced filtering and additional examples</li>
</ul>

<p><a id="graylog"> </a></p>

<h2 id="cluster-logs-with-graylog">Cluster logs with Graylog</h2>

<p>The recommended way to retrieve logs from your cluster is to use a combination
of <strong>Elasticsearch</strong>, <strong>Graylog</strong> and <strong>Filebeat</strong>. These provide a dashboard
from which you can monitor both machine-level and cluster-level logs.
See the <a href="/kubernetes/docs/quickstart">quickstart guide</a> for more details on installing <strong>Charmed Kubernetes</strong>.</p>

<h3 id="installation">Installation</h3>

<p>You can install <strong>Charmed Kubernetes</strong> with Graylog logging using the <strong>Juju</strong>
bundle along with the following overlay file
(<a href="https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/logging-egf-overlay.yaml">download it here</a>):</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">apache2</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:bionic/apache2</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">expose</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">enable_modules</span><span class="pi">:</span> <span class="s2">"</span><span class="s">headers</span><span class="nv"> </span><span class="s">proxy_html</span><span class="nv"> </span><span class="s">proxy_http"</span>
  <span class="na">elasticsearch</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:bionic/elasticsearch</span>
    <span class="na">constraints</span><span class="pi">:</span> <span class="s">mem=7G root-disk=16G</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">apt-repository</span><span class="pi">:</span> <span class="s2">"</span><span class="s">deb</span><span class="nv"> </span><span class="s">https://artifacts.elastic.co/packages/6.x/apt</span><span class="nv"> </span><span class="s">stable</span><span class="nv"> </span><span class="s">main"</span>
  <span class="na">filebeat</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:bionic/filebeat</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">install_sources</span><span class="pi">:</span> <span class="s2">"</span><span class="s">deb</span><span class="nv"> </span><span class="s">https://artifacts.elastic.co/packages/6.x/apt</span><span class="nv"> </span><span class="s">stable</span><span class="nv"> </span><span class="s">main"</span>
      <span class="na">kube_logs</span><span class="pi">:</span> <span class="s">True</span>
  <span class="na">graylog</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:bionic/graylog</span>
    <span class="na">constraints</span><span class="pi">:</span> <span class="s">mem=7G root-disk=16G</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">channel</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3/stable"</span>
  <span class="na">mongodb</span><span class="pi">:</span>
    <span class="na">charm</span><span class="pi">:</span> <span class="s">cs:bionic/mongodb</span>
    <span class="na">num_units</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">extra_daemon_options</span><span class="pi">:</span> <span class="s2">"</span><span class="s">--bind_ip_all"</span>
<span class="na">relations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s2">"</span><span class="s">apache2:reverseproxy"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">graylog:website"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s2">"</span><span class="s">graylog:elasticsearch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">elasticsearch:client"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s2">"</span><span class="s">graylog:mongodb"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">mongodb:database"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s2">"</span><span class="s">filebeat:beats-host"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">kubernetes-master:juju-info"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s2">"</span><span class="s">filebeat:beats-host"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">kubernetes-worker:juju-info"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="pi">[</span><span class="s2">"</span><span class="s">filebeat:logstash"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">graylog:beats"</span><span class="pi">]</span>
</code></pre></div></div>

<p>To use this overlay with the <strong>Charmed Kubernetes</strong> bundle, specify it
during deploy like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes <span class="nt">--overlay</span> ~/path/logging-egf-overlay.yaml
</code></pre></div></div>

<p>If you wish to add Graylog logging to an existing deployment, you can export a
bundle of your current environment and then redeploy it on top of itself with
the overlay:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju export-bundle <span class="nt">--filename</span> mybundle.yaml
juju deploy ./mybundle.yaml <span class="nt">--overlay</span> ~/path/logging-egf-overlay.yaml
</code></pre></div></div>

<p>At this point, all the applications can communicate with each other. To enable
the Graylog web interface, configure the reverse proxy with the following
template (<a href="https://raw.githubusercontent.com/charmed-kubernetes/kubernetes-docs/master/assets/graylog-vhost.tmpl">download it here</a>):</p>

<pre><code class="lang-bash">&lt;Location &quot;/&quot;&gt;
    RequestHeader set X-Graylog-Server-URL &quot;http:///&quot;
    ProxyPass http://&#123;&#123;graylog_web&#125;&#125;/
    ProxyPassReverse http://&#123;&#123;graylog_web&#125;&#125;/
&lt;/Location&gt;
</code></pre>

<p>Use the above template to configure <code class="highlighter-rouge">apache2</code> like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config apache2 <span class="nv">vhost_http_template</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">base64</span> ~/path/graylog-vhost.tmpl<span class="k">)</span><span class="s2">"</span>
</code></pre></div></div>

<h3 id="using-graylog">Using Graylog</h3>

<p>Now that we have everything configured, you’ll need to know the web server IP
address and Graylog admin password so you can login:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status <span class="nt">--format</span> yaml apache2/0 | <span class="nb">grep </span>public-address
    public-address: &lt;your-apache2-ip&gt;
juju run-action <span class="nt">--wait</span> graylog/0 show-admin-password
    admin-password: &lt;your-graylog-password&gt;
</code></pre></div></div>

<p>Browse to <code class="highlighter-rouge">http://&lt;your-apache2-ip&gt;</code> and login with <code class="highlighter-rouge">admin</code> as the username
and <code class="highlighter-rouge">&lt;your-graylog-password&gt;</code> as the password.</p>

<div class="p-notification--information">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
    If the interface is not immediately available, please wait as the reverse
    proxy configuration may take up to 5 minutes to complete.
  </p>
</div>

<p>Once logged in, head to the <code class="highlighter-rouge">Sources</code> tab to get an overview of the logs
collected from our K8s master and workers:</p>

<p><img src="https://assets.ubuntu.com/v1/5b8c576e-graylog-1.png" alt="Screen Shot of graylog" /></p>

<p>Drill into those logs by clicking the <code class="highlighter-rouge">System / Inputs</code> tab and selecting
<code class="highlighter-rouge">Show received messages</code> for the filebeat input:</p>

<p><img src="https://assets.ubuntu.com/v1/ee6de56c-graylog-2.png" alt="Screen Shot of graylog" /></p>

<p>From here, you may want to explore various filters or setup Graylog dashboards
to help identify the events that are most important to you. Check out the
<a href="http://docs.graylog.org/en/3.0/pages/dashboards.html">Graylog Dashboard docs</a> for details on customising your
view.</p>

<!--LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/logging.md" class="p-notification__action">edit this page</a>
    or
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
