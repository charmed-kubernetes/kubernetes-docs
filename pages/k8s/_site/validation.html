<p>End-to-end (e2e) tests for <strong>Kubernetes</strong> provide a mechanism to test the behaviour of the system. This is a useful indicator that the cluster is performing properly, as well as a good validation of any code changes.</p>

<p>For <strong>Charmed Kubernetes</strong>, these tests are encapsulated in an additional
<strong>Juju</strong> charm which can be added to your cluster. Actual testing is then run
through the charm’s actions.</p>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Caution:</span>
Your cluster will need to have at least two running worker units for the <code class="highlighter-rouge">e2e</code> test to run properly.
  </p>
</div>

<h2 id="deploying-the-kubernetes-e2e-charm">Deploying the kubernetes-e2e charm</h2>

<p>Add the charm to your cluster:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy cs:~containers/kubernetes-e2e <span class="nt">--constraints</span> <span class="nv">mem</span><span class="o">=</span>4G <span class="nt">--channel</span> edge
</code></pre></div></div>

<p>We also need to configure the charm to select the appropriate version of tests.
This relates to the installed version of Kubernetes. You can check which
version your cluster is set to by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master channel
</code></pre></div></div>

<p>The output will be in the form of ‘version.number/risk’, e.g ‘1.12/stable’. You should set
the <code class="highlighter-rouge">kubernetes-e2e</code> channel to the same value.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-e2e channel=1.12/stable
</code></pre></div></div>

<p>Finally we relate the charm to <code class="highlighter-rouge">easyrsa</code> and <code class="highlighter-rouge">kubernetes-master</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master allow-privileged<span class="o">=</span><span class="nb">true
</span>juju config kubernetes-worker allow-privileged<span class="o">=</span><span class="nb">true
</span>juju add-relation kubernetes-e2e easyrsa
juju add-relation kubernetes-e2e:kubernetes-master kubernetes-master:kube-api-endpoint
juju add-relation kubernetes-e2e:kube-control kubernetes-master:kube-control
</code></pre></div></div>

<p>It may take some moments for these relations to establish. Once the connections are made, the charm will update its status to “Ready to test.”</p>

<h2 id="running-the-default-tests">Running the default tests</h2>

<p>The tests are configured as a <strong>Juju</strong> <em>action</em>. To run the default tests:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-e2e/0 <span class="nb">test</span>
</code></pre></div></div>

<p>The command will return with a uuid for that specific test run. See the section
on <em>Test output</em> below for details.</p>

<h2 id="running-specific-tests">Running specific tests</h2>

<p>The complete set of <strong>Kubernetes</strong> e2e tests is more fully described in the
<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/e2e-tests.md">upstream Kubernetes documentation</a>. In some cases you may wish
to omit particular groups of tests. This is possible by applying a regular
expression defining the tests to omit when initiating the action.</p>

<p>By default, the standard tests marked <code class="highlighter-rouge">[Flaky]</code> or <code class="highlighter-rouge">[Serial]</code> are skipped. To
also omit the tests marked as <code class="highlighter-rouge">[Slow]</code>, you could run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-e2e/0 <span class="nb">test </span><span class="nv">skip</span><span class="o">=</span><span class="s1">'\[(Flaky|Slow|Serial)\]'</span>
</code></pre></div></div>

<p>Note that the brackets for the regex need to be escaped as shown.</p>

<p>Running this command will return a uuid for that specific test run, as with the default case.</p>

<h2 id="test-output">Test output</h2>

<p>You can check on the current status of the test by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju show-action-status 8f8ec748-6ca7-4bbb-86f8-f37e44ba46f9
</code></pre></div></div>

<p>where <code class="highlighter-rouge">8f8ec748-6ca7-4bbb-86f8-f37e44ba46f9</code> is the uuid of the action returned
when we initiated the test. This will return YAML output indicating the current
status, which can be either <code class="highlighter-rouge">running</code>, <code class="highlighter-rouge">completed</code> or <code class="highlighter-rouge">failed</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">actions</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">action</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">completed at</span><span class="pi">:</span> <span class="s">n/a</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">8f8ec748-6ca7-4bbb-86f8-f37e44ba46f9</span>
  <span class="na">status</span><span class="pi">:</span> <span class="s">running</span>
  <span class="na">unit</span><span class="pi">:</span> <span class="s">e2e/0</span>
</code></pre></div></div>

<p>Once completed, you can see more detail on the timing by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju show-action-status  8f8ec748-6ca7-4bbb-86f8-f37e44ba46f9
</code></pre></div></div>

<p>Which will return output similar to:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">results</span><span class="pi">:</span>
  <span class="na">junit</span><span class="pi">:</span> <span class="s">/home/ubuntu/8f8ec748-6ca7-4bbb-86f8-f37e44ba46f9-junit.tar.gz</span>
  <span class="na">log</span><span class="pi">:</span> <span class="s">/home/ubuntu/8f8ec748-6ca7-4bbb-86f8-f37e44ba46f9.log.tar.gz</span>
<span class="na">status</span><span class="pi">:</span> <span class="s">completed</span>
<span class="na">timing</span><span class="pi">:</span>
  <span class="na">completed</span><span class="pi">:</span> <span class="s">2018-10-06 18:33:15 +0000 UTC</span>
  <span class="na">enqueued</span><span class="pi">:</span> <span class="s">2018-10-06 18:25:30 +0000 UTC</span>
  <span class="na">started</span><span class="pi">:</span> <span class="s">2018-10-06 18:25:30 +0000 UTC</span>
</code></pre></div></div>

<p>If the tests fail, or you want to look through the detail of each test, you can examine the
detailed log.</p>

<h2 id="viewing-test-logs">Viewing test logs</h2>

<p>The test logfile is stored as a file on the test instance. The filename
corresponds to the uuid of the action which created it, with a ‘.log’
extension, and it is stored in the <code class="highlighter-rouge">/home/ubuntu/</code> directory of the machine
where the tests are running. A compressed version is also stored with the
extension <code class="highlighter-rouge">.log.tar.gz</code></p>

<p>This log can be copied to your local machine for easier viewing:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju scp kubernetes-e2e/0:4ceed33a-d96d-465a-8f31-20d63442e51b.log  <span class="nb">.</span>
</code></pre></div></div>

<p>Note that the captured test logfile uses ANSI output, and is best viewed with
<code class="highlighter-rouge">cat</code>, <code class="highlighter-rouge">tail</code> or a similar command which can handle this type of output.
Alternatively, you can strip the ANSI parts of the output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">fn</span><span class="o">=</span>&lt;your log file name&gt;
<span class="nb">echo</span> <span class="nt">-ne</span> <span class="k">$(</span><span class="nb">cat</span> <span class="nv">$fn</span> | <span class="nb">sed</span>  <span class="s1">'s/$/\\n/'</span> | <span class="nb">sed</span> <span class="s1">'s/\x1B\[[0-9]*\w//g'</span><span class="k">)</span>
</code></pre></div></div>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Caution:</span>
If you are running regular tests in this way, it is advisable to remove the generated logs from the test unit. The uncompressed logs in particular can be very large and quickly fill up storage.
  </p>
</div>

<h2 id="upgrading-the-e2e-tests">Upgrading the e2e tests</h2>

<p>When an update is available, the <code class="highlighter-rouge">kubernetes-e2e</code> charm can be upgraded with the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm kubernetes-e2e
</code></pre></div></div>

<!--LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/validation.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
