<p>Kubernetes auditing provides a security-relevant chronological set of records
documenting the sequence of activities that have affected the system by
individual users, administrators or other components of the system. This
documentation covers the configuration and usage of these audit logs in
<strong>Charmed Kubernetes</strong>. For a more detailed description of the motives and
methodology behind audit logging in Kubernetes, see the
<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/">Kubernetes Auditing documentation</a>.</p>

<h2 id="viewing-the-log">Viewing the log</h2>

<p>By default, <strong>Charmed Kubernetes</strong> enables audit logging to files on the
<code class="highlighter-rouge">kubernetes-master</code> units. The log file is located at
<code class="highlighter-rouge">/root/cdk/audit/audit.log</code> and is owned by the nominal <code class="highlighter-rouge">root</code> user. You can
view the log directly by using Juju’s credentials to make an SSH connection:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju ssh kubernetes-master/0 <span class="nb">sudo cat</span> /root/cdk/audit/audit.log
</code></pre></div></div>

<p>Note that this log is replicated on all kubernetes-master units.</p>

<h2 id="audit-policy-configuration">Audit policy configuration</h2>

<p>Audit policy defines rules about what events should be recorded and what data
they should include.  For <strong>Charmed Kubernetes</strong> this is configurable on the kubernetes-master charm
using the <code class="highlighter-rouge">audit-policy</code> setting.</p>

<p>To view the current policy:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master audit-policy
</code></pre></div></div>

<p>To set a new audit policy, it is easiest to write the policy to a file. Assuming you have a file
named <code class="highlighter-rouge">audit-policy.yaml</code> with the following contents:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Log all requests at the Metadata level.</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">audit.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Policy</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">level</span><span class="pi">:</span> <span class="s">Metadata</span>
</code></pre></div></div>

<p>You can set the new audit policy like so:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master audit-policy<span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">cat </span>audit-policy.yaml<span class="k">)</span><span class="s2">"</span>
</code></pre></div></div>

<p>For more information about audit policy definitions, please refer to the
upstream <a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/#policy">Kubernetes Audit Policy documentation</a>.</p>

<h2 id="audit-log-backend-configuration">Audit log backend configuration</h2>

<p>The audit log backend writes audit events to a file in JSON format. It is
configurable in <strong>Charmed Kubernetes</strong>  through the use of the <code class="highlighter-rouge">api-extra-args</code>
config on kubernetes-master.</p>

<p>By default, the log backend is enabled in Charmed Kubernetes with the following
configuration:</p>

<table>
  <thead>
    <tr>
      <th>kube-apiserver config</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>audit-log-path</td>
      <td>/root/cdk/audit/audit.log</td>
    </tr>
    <tr>
      <td>audit-log-maxsize</td>
      <td>100</td>
    </tr>
    <tr>
      <td>audit-log-maxbackup</td>
      <td>9</td>
    </tr>
  </tbody>
</table>

<p>You can override the defaults by using <code class="highlighter-rouge">api-extra-args</code>. For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master api-extra-args<span class="o">=</span><span class="s2">"audit-log-path=/root/cdk/my-audit-location audit-log-maxage=30 audit-log-maxsize=200 audit-log-maxbackup=5"</span>
</code></pre></div></div>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
    The <code>audit-log-path</code> must be a directory that is writeable by the
     kube-apiserver snap.
     Any non-hidden folders in <code>/root</code>, <code>/var/snap/kube-apiserver/current</code>, or
     <code>/var/snap/kube-apiserver/common</code> should work.
  </p>
</div>

<p>Please refer to the upstream
<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/#log-backend">Kubernetes Audit Log Backend documentation</a>
for more information about the available options.</p>

<h2 id="audit-webhook-backend-configuration">Audit webhook backend configuration</h2>

<p>The audit webhook backend sends audit events to a remote API, which is assumed
to be the same API that the kube-apiserver exposes. This backend is disabled by
default in <strong>Charmed Kubernetes</strong>, and is configurable on the kubernetes-master
charm via the <code class="highlighter-rouge">audit-webhook-config</code> option.</p>

<p>To view the current audit webhook configuration:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master audit-webhook-config
</code></pre></div></div>

<p>To set a new audit webhook config, it is easiest to write the config to a file.
Assuming you have a file named <code class="highlighter-rouge">audit-webhook-config.yaml</code> with the following
contents:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">clusters</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">example-cluster</span>
  <span class="na">cluster</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">http://10.1.35.4</span>
<span class="na">users</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">example-user</span>
  <span class="na">user</span><span class="pi">:</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">some-user</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">some-password</span>
<span class="na">contexts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">example-context</span>
  <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">example-cluster</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">example-user</span>
<span class="na">current-context</span><span class="pi">:</span> <span class="s">example-context</span>
</code></pre></div></div>

<p>You can set the new audit webhook config with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master audit-webhook-config<span class="o">=</span>”<span class="k">$(</span><span class="nb">cat </span>audit-webhook-config.yaml<span class="k">)</span>”
</code></pre></div></div>

<p>Additional options for the webhook backend can be set by using <code class="highlighter-rouge">api-extra-args</code>.
For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master api-extra-args<span class="o">=</span><span class="s2">"audit-webhook-initial-backoff=20s"</span>
</code></pre></div></div>

<p>Please refer to the upstream
<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/#webhook-backend">Kubernetes Audit Webhook Backend documentation</a> for more
information about the audit webhook config format and related options.</p>

<!-- LINKS -->

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/audit-logging.md" class="p-notification__action">edit this page</a>
    or
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
