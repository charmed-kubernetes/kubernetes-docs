<p>It is recommended that you keep your <strong>Kubernetes</strong> deployment updated to the latest available stable version. You should also update the other applications which make up the <strong>Charmed Kubernetes</strong>. Keeping up to date ensures you have the latest bug-fixes and security patches for smooth operation of your cluster.</p>

<p>New minor versions of <strong>Kubernetes</strong> are set to release once per quarter. You can check the latest release version on the <a href="https://github.com/kubernetes/kubernetes/releases">Kubernetes release page on GitHub</a>. <strong>Charmed Kubernetes</strong> is kept in close sync with upstream Kubernetes: updated versions will be released within a week of a new upstream version of <strong>Kubernetes</strong>.</p>

<div class="p-notification--information">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
<strong>Kubernetes</strong> will automatically handle patch releases. This means that the cluster will perform an unattended automatic upgrade between patch versions, e.g. 1.10.7 to 1.10.8. Attended upgrades are only required when you wish to upgrade a minor version, e.g. 1.9.x to 1.10.x.
  </p>
</div>

<p>You can see which version of each application is currently deployed by running</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status
</code></pre></div></div>

<p>The ‘App’ section of the output lists each application and its version number. Note that this is the version of the upstream application deployed. The version of the Juju charm is indicated under the column titled ‘Rev’. The charms may be updated in between new versions of the application.</p>

<p><img src="https://assets.ubuntu.com/v1/6691d706-CDK-010.png" alt="juju output" /></p>

<h2 id="before-you-begin">Before you begin</h2>

<p>As with all upgrades, there is a possibility that there may be unforeseen difficulties. It is <strong>highly recommended that you make a backup</strong> of any important data, including any running workloads. For more details on creating backups, see the separate <a href="/kubernetes/docs/backups">documentation on backups</a>.</p>

<p>You should also make sure:</p>

<ul>
  <li>The machine from which you will perform the backup has sufficient internet access to retrieve updated software</li>
  <li>Your cluster is running normally</li>
  <li>You read the <a href="/kubernetes/docs/upgrade-notes">Upgrade notes</a> to see if any caveats apply to the versions you are upgrading to/from</li>
  <li>You read the [Release notes][release-notes] for the version you are upgrading to, which will alert you to any important changes to the operation of your cluster</li>
</ul>

<h2 id="infrastructure-updates">Infrastructure updates</h2>

<p>The applications which run alongside the core Kubernetes components can be upgraded at any time. These applications are widely used and may frequently receive upgrades outside of the cycle of new releases of Kubernetes.</p>

<p>This includes:</p>

<ul>
  <li>Docker</li>
  <li>easyrsa</li>
  <li>etcd</li>
  <li>flannel</li>
</ul>

<p>Note that this may include other applications which you may have installed, such as Elasticsearch, Prometheus, Nagios, Helm, etc.</p>

<p><a id="upgrading-docker"> </a></p>

<h3 id="upgrading-docker">Upgrading Docker</h3>

<p><strong>Charmed Kubernetes</strong> will use the latest stable version of Docker when it is deployed. Since upgrading Docker
can cause service disruption, there will be no automatic upgrades and instead this process must
be triggered by the operator.</p>

<p>Note that this upgrade step only applies to deployments which actually use the Docker
container runtime. Versions 1.15 and later use containerd by default, and you should
instead follow the <a href="#upgrading-containerd">instructions below</a>.</p>

<h4 id="version-115-and-later">Version 1.15 and later</h4>

<p>The <code class="highlighter-rouge">kubernetes-master</code> and <code class="highlighter-rouge">kubernetes-worker</code> are related to the docker subordinate
charm where present. Whether you are running Docker on its own, or mixed with Containerd,
the upgrade process is the same:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm docker
</code></pre></div></div>

<h4 id="versions-prior-to-115">Versions prior to 1.15</h4>
<p>Only the <code class="highlighter-rouge">kubernetes-master</code> and <code class="highlighter-rouge">kubernetes-worker</code> units require Docker. The charms for each
include an action to trigger the upgrade.</p>

<p>Before the upgrade, it is useful to list all the units effected:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status kubernetes-<span class="k">*</span> <span class="nt">--format</span><span class="o">=</span>short
</code></pre></div></div>

<p>…will return a list of the current <code class="highlighter-rouge">kubernetes-master</code> and <code class="highlighter-rouge">kubernetes-worker</code> units.</p>

<p>Start with the <code class="highlighter-rouge">kubernetes-master</code> units and run the upgrade action on one unit at a time:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-master/0 upgrade-docker <span class="nt">--wait</span>
</code></pre></div></div>

<p>As Docker is restarted on the unit, pods will be terminated. Wait for them to respawn before
moving on to the next unit:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-master/1 upgrade-docker <span class="nt">--wait</span>
</code></pre></div></div>

<p>Once all the <code class="highlighter-rouge">kubernetes-master</code> units have been upgraded and the pods have respawned, the
same procedure can then be applied to the <code class="highlighter-rouge">kubernetes-worker</code> units.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-worker/0 upgrade-docker <span class="nt">--wait</span>
</code></pre></div></div>

<p>As previously, wait between running the action on sucessive units to allow pods to migrate.</p>

<p><a id="upgrading-containerd"> </a></p>

<h3 id="upgrading-containerd">Upgrading containerd</h3>

<p>By default, Versions 1.15 and later use Containerd as the container
runtime. This subordinate charm can be upgraded with the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm containerd
</code></pre></div></div>

<h3 id="upgrading-etcd">Upgrading etcd</h3>

<p>As <strong>etcd</strong> manages critical data for the cluster, it is advisable to create a snapshot of
this data before running an upgrade. This is covered in more detail in the
<a href="/kubernetes/docs/backups">documentation on backups</a>, but the basic steps are:</p>

<h4 id="1-run-the-snapshot-action-on-the-charm">1. Run the snapshot action on the charm</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action etcd/0 snapshot <span class="nt">--wait</span>
</code></pre></div></div>
<p>You should see confirmation of the snapshot being created, and the location of the file
<em>on the <strong>etcd</strong> unit</em></p>

<h4 id="2-fetch-a-local-copy-of-the-snapshot">2. Fetch a local copy of the snapshot</h4>

<p>Knowing the path to the snapshot file from the output of the above command, you can
download a local copy:
<code class="highlighter-rouge">bash juju scp etcd/0:/home/ubuntu/etcd-snapshots/&lt;filename&gt;.tar.gz .</code></p>

<h4 id="3-upgrade">3. Upgrade</h4>

<p>You can now upgrade <strong>etcd</strong>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm etcd
</code></pre></div></div>

<h3 id="upgrading-additional-components">Upgrading additional components</h3>

<p>The other infrastructure applications can be upgraded by running the <code class="highlighter-rouge">upgrade-charm</code>
command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm flannel
juju upgrade-charm easyrsa
</code></pre></div></div>

<p>Any other infrastructure charms can be upgraded in a similar way.</p>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
Some services may be briefly interrupted during the upgrade process. Upgrading
<strong>flannel</strong> will cause a small amount of network downtime. Upgrading
<strong>easyrsa</strong> will not cause any downtime. The behaviour of other
components you have added to your cluster may vary - check individual documentation
for these charms for more information on upgrades.
  </p>
</div>

<h2 id="upgrading-kubernetes">Upgrading Kubernetes</h2>

<p>Before you upgrade the <strong>Kubernetes</strong> components, you should be aware of the exact
release you wish to upgrade to.</p>

<p>The <strong>Kubernetes</strong> charms use <strong>snap</strong> <em>channels</em> to manage the version of
<strong>Kubernetes</strong> to use. Channels are explained in more detail in the
<a href="https://docs.snapcraft.io/reference/channels">official snap documentation</a>, but in terms of <strong>Kubernetes</strong> all you
need to know are the major and minor version numbers and the ‘risk-level’:</p>

<table>
  <thead>
    <tr>
      <th>Risk level</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>stable</td>
      <td>The latest stable released version of Kubernetes</td>
    </tr>
    <tr>
      <td>candidate</td>
      <td>Release candidate versions of Kubernetes</td>
    </tr>
    <tr>
      <td>beta</td>
      <td>Latest alpha/beta of Kubernetes for the specified release</td>
    </tr>
    <tr>
      <td>edge</td>
      <td>Nightly builds of the specified release of Kubernetes</td>
    </tr>
  </tbody>
</table>

<p>For most use cases, it is strongly recommended to use the ‘stable’ version of charms.</p>

<h3 id="upgrading-the-kube-api-loadbalancer">Upgrading the <strong>kube-api-loadbalancer</strong></h3>

<p>A core part of <strong>Charmed Kubernetes</strong> is the kubeapi-load-balancer component. To ensure API service
continuity this upgrade should precede any upgrades to the <strong>Kubernetes</strong> master and
worker units.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm kubeapi-load-balancer
</code></pre></div></div>

<p>The load balancer itself is based on NGINX, and the version reported by <code class="highlighter-rouge">juju status</code> is
that of NGINX rather than Kubernetes. Unlike the other Kubernetes components, there
is no need to set a specific channel or version for this charm.</p>

<h3 id="upgrading-the-kubernetes-master-units">Upgrading the <strong>kubernetes-master</strong> units</h3>

<p>To start upgrading the Kubernetes master units, first upgrade the charm:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm kubernetes-master
</code></pre></div></div>

<p>Once the charm has been upgraded, it can be configured to select the desired <strong>Kubernetes</strong> channel, which takes the form <code class="highlighter-rouge">Major.Minor/risk-level</code>. This is then passed as a configuration option to the charm. So, for example, to select the stable 1.10 version of <strong>Kubernetes</strong>, you would enter:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-master <span class="nv">channel</span><span class="o">=</span>1.10/stable
</code></pre></div></div>

<p>If you wanted to try a release candidate for 1.12, the channel would be <code class="highlighter-rouge">1.12/candidate</code>.</p>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
Once the configuration has been changed, the charms will be put into a <code class="highlighter-rouge">blocked</code> state.
You must continue the upgrade process, even if you revert the configuration to the
currently active version of Kubernetes.
  </p>
</div>

<p>Once the desired version has been configured, the upgrades should be performed. This is done by running the <code class="highlighter-rouge">upgrade</code> action on each master unit in the cluster:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-master/0 upgrade
juju run-action kubernetes-master/1 upgrade
</code></pre></div></div>

<p>If you have more master units in your cluster, you should continue and run this process on every one of them.</p>

<p>You can check the progress of the upgrade by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status | <span class="nb">grep </span>master
</code></pre></div></div>

<p>Ensure that all the master units have upgraded and are reporting normal status before continuing to upgrade the worker units.</p>

<h3 id="upgrading-the-kubernetes-worker-units">Upgrading the <strong>kubernetes-worker</strong> units</h3>

<div class="p-notification--caution">
  <p class="p-notification__response">
    <span class="p-notification__status">Caution:</span>
    A <a href="https://github.com/kubernetes/kubernetes/issues/70044"> current bug in Kubernetes</a> could prevent the upgrade from properly deleting old pods. See the <a href="#known-issues"> Known issues section</a> at the bottom of this page.
</p>
</div>

<p>For a running cluster, there are two different ways to proceed:</p>

<ul>
  <li><a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">Blue-green</a> upgrade - This requires more resources, but should ensure a safe, zero-downtime transition of workloads to an updated cluster</li>
  <li>In-place upgrade - this simply upgrades the workers in situ, which may involve some service interruption but doesn’t require extra resources</li>
</ul>

<p>Both methods are outlined below. The blue-green method is recommended for production systems.</p>

<h4 id="blue-green-upgrade">Blue-green upgrade</h4>

<p>To begin, upgrade the kubernetes-worker charm itself:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm kubernetes-worker
</code></pre></div></div>

<p>Next, run the command to configure the workers for the version of Kubernetes you wish to run (as you did previously for the master units). For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-worker <span class="nv">channel</span><span class="o">=</span>1.12/stable
</code></pre></div></div>

<p>Now add additional units of the kubernetes-worker. You should add as many units as you are replacing. For example, to add three additional units:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju add-unit kubernetes-worker <span class="nt">-n</span> 3
</code></pre></div></div>

<p>This will create new units to migrate the existing workload to. As you configured the version prior to adding the units, they will be using the newly-selected version of <strong>Kubernetes</strong>.</p>

<p>Now we can pause the existing workers, which will cause the workloads to migrate to the new units recently added. A worker unit is paused by running the corresponding action on that unit:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-worker/0 pause
juju run-action kubernetes-worker/1 pause
juju run-action kubernetes-worker/2 pause
...
</code></pre></div></div>

<p>Continue until all the ‘old’ units have been paused. You can check on the workload status by running the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod <span class="nt">-o</span> wide
</code></pre></div></div>

<p>Once the workloads are running on the new units, it is safe to remove the old units:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju remove-unit kubernetes-worker/0
</code></pre></div></div>

<p>Removing these units from the model will also release the underlying machines/instances they were running on, so no further clean up is required.</p>

<div class="p-notification--information">
  <p class="p-notification__response">
    <span class="p-notification__status">Note:</span>
A variation on this method is to add, pause, remove  and recycle units one at a time. This reduces the resource overhead to a single extra instance.
  </p>
</div>

<h4 id="in-place-upgrade">In-place upgrade</h4>

<p>To proceed with an in-place upgrade, first upgrade the charm itself:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju upgrade-charm kubernetes-worker
</code></pre></div></div>

<p>Next, run the command to configure the workers for the version of <strong>Kubernetes</strong> you wish to run (as you did previously for the master units). For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju config kubernetes-worker <span class="nv">channel</span><span class="o">=</span>1.12/stable
</code></pre></div></div>

<p>All the units can now be upgraded by running the <code class="highlighter-rouge">upgrade</code> action on each one:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju run-action kubernetes-worker/0 upgrade
juju run-action kubernetes-worker/1 upgrade
...
</code></pre></div></div>

<h2 id="verify-your-upgrade">Verify your upgrade</h2>

<p>The output from:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju status
</code></pre></div></div>

<p>… should now indicate the selected version of <strong>Kubernetes</strong> is running.</p>

<p>It is recommended that you run a <a href="/kubernetes/docs/validation">cluster validation</a> to ensure that the cluster upgrade has successfully completed.</p>

<h2 id="known-issues">Known Issues</h2>

<p>A <a href="https://github.com/kubernetes/kubernetes/issues/70044">current bug</a> in Kubernetes could prevent the upgrade from properly deleting old pods. You can see such an issue here:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get po <span class="nt">--all-namespaces</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAMESPACE                         NAME                                                          READY   STATUS        RESTARTS   AGE
default                           nginx-ingress-kubernetes-worker-controller-r8d2v              0/1     Terminating   0          17m
ingress-nginx-kubernetes-worker   default-http-backend-kubernetes-worker-5d9bb77bc5-76c8w       1/1     Running       0          10m
ingress-nginx-kubernetes-worker   nginx-ingress-controller-kubernetes-worker-5dcf47fc4c-q9mh6   1/1     Running       0          10m
kube-system                       heapster-v1.6.0-beta.1-6db4b87d-phjvb                         4/4     Running       0          16m
kube-system                       kube-dns-596fbb8fbd-bp8lz                                     3/3     Running       0          18m
kube-system                       kubernetes-dashboard-67d4c89764-nwxss                         1/1     Running       0          18m
kube-system                       metrics-server-v0.3.1-67bb5c8d7-x9nzx                         2/2     Running       0          17m
kube-system                       monitoring-influxdb-grafana-v4-65cc9bb8c8-mwvcm               2/2     Running       0          17m
</code></pre></div></div>

<p>In this case the  <code class="highlighter-rouge">nginx-ingress-kubernetes-worker-controller-r8d2v</code> has been stuck in the <code class="highlighter-rouge">Terminating</code> state for roughly 10 minutes. The workaround for such a problem is to force a deletion:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete po/nginx-ingress-kubernetes-worker-controller-r8d2v <span class="nt">--force</span> <span class="nt">--grace-period</span><span class="o">=</span>0
</code></pre></div></div>

<p>This will result in output similar to the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.
pod "nginx-ingress-kubernetes-worker-controller-r8d2v" force deleted
</code></pre></div></div>

<p>You should verify that the pod has been sucessfully removed:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get po <span class="nt">--all-namespaces</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAMESPACE                         NAME                                                          READY   STATUS    RESTARTS   AGE
ingress-nginx-kubernetes-worker   default-http-backend-kubernetes-worker-5d9bb77bc5-76c8w       1/1     Running   0          11m
ingress-nginx-kubernetes-worker   nginx-ingress-controller-kubernetes-worker-5dcf47fc4c-q9mh6   1/1     Running   0          11m
kube-system                       heapster-v1.6.0-beta.1-6db4b87d-phjvb                         4/4     Running   0          17m
kube-system                       kube-dns-596fbb8fbd-bp8lz                                     3/3     Running   0          19m
kube-system                       kubernetes-dashboard-67d4c89764-nwxss                         1/1     Running   0          19m
kube-system                       metrics-server-v0.3.1-67bb5c8d7-x9nzx                         2/2     Running   0          18m
kube-system                       monitoring-influxdb-grafana-v4-65cc9bb8c8-mwvcm               2/2     Running   0          18m
</code></pre></div></div>

<p><!--LINKS--></p>

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/upgrading.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
