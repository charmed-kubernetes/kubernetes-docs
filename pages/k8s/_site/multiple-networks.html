<p>Using network spaces and bindings in Juju, it’s possible to deploy Charmed
Kubernetes in an environment with multiple networks and assign traffic to
different networks explicitly.</p>

<p>Currently, multiple networks are only supported in Juju on MAAS.</p>

<p>The rest of this document assumes you’re familiar with the basics of MAAS and
Juju. If you’re not, you can familiarise yourself with them by reading the
<a href="https://maas.io/docs">MAAS documentation</a> and
<a href="https://jaas.ai/docs">Juju documentation</a>.</p>

<h2 id="configure-maas">Configure MAAS</h2>

<p>Preconditions:</p>

<ul>
  <li>You have MAAS nodes that are attached to multiple logical networks (separate
physical networks or VLANs).</li>
  <li>You have commissioned the nodes in MAAS.</li>
</ul>

<h3 id="create-spaces-in-maas">Create spaces in MAAS</h3>

<p>In the ‘Subnets’ tab of the MAAS GUI, click <code class="highlighter-rouge">Add -&gt; Space</code> to create spaces as
needed. To add subnets to a space, enter the subnet’s VLAN configuration page
(click in the ‘VLAN’ column on the main Subnets page) and assign it to the space.</p>

<h3 id="enable-network-interfaces-on-nodes">Enable network interfaces on nodes</h3>

<p>By default, only the first network interface is enabled on each node. You need
to manually enable the rest.</p>

<p>Go to the ‘Nodes’ tab, click on a node, and click the ‘Interfaces’ tab. Set
each interface’s IP mode to <code class="highlighter-rouge">Auto assign</code>.</p>

<h2 id="configure-juju">Configure Juju</h2>

<p>If you’ve already bootstrapped a Juju controller, use <code class="highlighter-rouge">juju reload-spaces</code> to
pick up the changes from MAAS. Otherwise, bootstrap a new Juju controller and
the new controller should pick up the spaces automatically.</p>

<p>Run <code class="highlighter-rouge">juju spaces</code> and make sure you see the network spaces and subnet
assignments that you’re expecting to see.</p>

<h2 id="use-bindings-to-direct-network-traffic">Use bindings to direct network traffic</h2>

<p>Using bindings, you can direct specific kinds of network traffic in your Charmed
Kubernetes cluster to go through specific networks.</p>

<p>The easiest way to do this is by using an overlay file when you deploy Charmed
Kubernetes. The following is an example overlay that defaults all bindings to
send traffic through a network space named <code class="highlighter-rouge">control</code>, with the exception of the
flannel cni binding, which will send its traffic through a network space named
<code class="highlighter-rouge">workload</code> instead:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">applications</span><span class="pi">:</span>
  <span class="na">easyrsa</span><span class="pi">:</span>
    <span class="na">bindings</span><span class="pi">:</span>
      <span class="s2">"</span><span class="s">"</span><span class="pi">:</span> <span class="s">control</span>
  <span class="na">etcd</span><span class="pi">:</span>
    <span class="na">bindings</span><span class="pi">:</span>
      <span class="s2">"</span><span class="s">"</span><span class="pi">:</span> <span class="s">control</span>
  <span class="na">kubeapi-load-balancer</span><span class="pi">:</span>
    <span class="na">bindings</span><span class="pi">:</span>
      <span class="s2">"</span><span class="s">"</span><span class="pi">:</span> <span class="s">control</span>
  <span class="na">kubernetes-master</span><span class="pi">:</span>
    <span class="na">bindings</span><span class="pi">:</span>
      <span class="s2">"</span><span class="s">"</span><span class="pi">:</span> <span class="s">control</span>
  <span class="na">kubernetes-worker</span><span class="pi">:</span>
    <span class="na">bindings</span><span class="pi">:</span>
      <span class="s2">"</span><span class="s">"</span><span class="pi">:</span> <span class="s">control</span>
  <span class="na">kubernetes-worker</span><span class="pi">:</span>
    <span class="na">bindings</span><span class="pi">:</span>
      <span class="s2">"</span><span class="s">"</span><span class="pi">:</span> <span class="s">control</span>
  <span class="na">containerd</span><span class="pi">:</span>
    <span class="na">bindings</span><span class="pi">:</span>
      <span class="s2">"</span><span class="s">"</span><span class="pi">:</span> <span class="s">control</span>
  <span class="na">flannel</span><span class="pi">:</span>
    <span class="na">bindings</span><span class="pi">:</span>
      <span class="s2">"</span><span class="s">"</span><span class="pi">:</span> <span class="s">control</span>
      <span class="na">cni</span><span class="pi">:</span> <span class="s">workload</span>
</code></pre></div></div>

<p>Once you have an overlay file created, use it to deploy Charmed Kubernetes with
your bindings:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>juju deploy charmed-kubernetes <span class="nt">--overlay</span> my-overlay.yaml
</code></pre></div></div>

<p>The following endpoints are available for use in bindings:</p>

<table>
  <thead>
    <tr>
      <th>Charm</th>
      <th>Endpoint</th>
      <th>Description of traffic</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>etcd</td>
      <td>cluster</td>
      <td>ETCD internal (peer)</td>
    </tr>
    <tr>
      <td>etcd</td>
      <td>db</td>
      <td>ETCD external (client)</td>
    </tr>
    <tr>
      <td>flannel</td>
      <td>cni</td>
      <td>Flannel traffic (pod to pod communication)</td>
    </tr>
    <tr>
      <td>canal</td>
      <td>cni</td>
      <td>Flannel traffic (pod to pod communication)</td>
    </tr>
    <tr>
      <td>calico</td>
      <td>cni</td>
      <td>Calico traffic (pod to pod communication)</td>
    </tr>
    <tr>
      <td>kubernetes-master</td>
      <td>kube-api-endpoint</td>
      <td>Main traffic to kube-apiserver, from kubeapi-load-balancer</td>
    </tr>
    <tr>
      <td>kubernetes-master</td>
      <td>kube-control</td>
      <td>Secondary traffic to kube-apiserver, from pods</td>
    </tr>
    <tr>
      <td>kubeapi-load-balancer</td>
      <td>website</td>
      <td>Traffic to kubeapi-load-balancer, from kubectl, kubelet and kube-proxy</td>
    </tr>
    <tr>
      <td>kubernetes-worker</td>
      <td>kube-control</td>
      <td>Traffic to kubelet, from kube-apiserver (health checks)</td>
    </tr>
  </tbody>
</table>

<p>You can read more about bindings in the Juju documentation here:
<a href="https://jaas.ai/docs/charm-bundles#heading--binding-endpoints-within-a-bundle">Binding endpoints within a bundle</a></p>

<!-- FEEDBACK -->
<div class="p-notification--information">
  <p class="p-notification__response">
    We appreciate your feedback on the documentation. You can 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/edit/master/pages/k8s/multiple-networks.md" class="p-notification__action">edit this page</a> 
    or 
    <a href="https://github.com/charmed-kubernetes/kubernetes-docs/issues/new" class="p-notification__action">file a bug here</a>.
  </p>
</div>
